<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>價格追蹤小幫手 - 雲端同步版</title>
    <!-- PWA Optimization Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: none;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-bottom: 0.5rem; color: #111827; }
        .prose p { margin-bottom: 0.5rem; line-height: 1.6; color: #374151; }
        .prose strong { color: #0d9488; font-weight: 700; }
        /* Hide quantity field by default for weight items */
        #quantity-group { display: none; }
        #modal-add-price .group-item-only { transition: opacity 0.3s ease; }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div class="relative w-full h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden">
        
        <!-- Loading State Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[100] flex items-center justify-center flex-col transition-opacity duration-500">
            <div id="loading-spinner" class="loader mb-4"></div>
            <p class="text-lg text-teal-600 font-medium" id="loading-text">正在連線雲端資料庫...</p>
        </div>

        <!-- PAGE 1: Home (Product List) -->
        <div id="page-home" class="page active">
            <header class="bg-teal-600 text-white p-4 shadow-md z-20 sticky top-0">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced"></i> 價格對比追蹤 (雲端版)
                </h1>
                <p class="text-sm text-teal-200 mt-1">統一換算為 <span class="font-bold">每單位價格 (克或件)</span> 進行比較</p>
                <!-- User ID Display for Debug/Sync -->
                <p class="text-xs text-teal-300 mt-1" id="user-sync-info">同步狀態: 載入中...</p>
                <!-- Search -->
                <div class="relative mt-3">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="搜尋商品名稱..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-300 shadow-inner"
                        oninput="handleSearch(this.value)">
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="product-list-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Product -->
            <button onclick="openModal('modal-add-product')" class="absolute bottom-6 right-6 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-teal-700 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- PAGE 2: Detail (Price History) -->
        <div id="page-detail" class="page">
            <header class="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3 z-20 sticky top-0">
                <button onclick="goHome()" class="text-white p-2 -ml-2 btn-active">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold truncate flex-1" id="detail-title">商品名稱</h1>
                <div class="flex gap-1">
                    <button onclick="openEditModal()" class="text-white p-2 btn-active" title="編輯名稱">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                     <button onclick="deleteCurrentProduct()" class="text-white p-2 btn-active" title="刪除商品">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </header>

            <!-- Stats Area (Now showing Min Price per Unit) -->
            <div class="bg-white p-4 shadow-sm mb-2 z-10 sticky top-[64px] flex justify-between items-end">
                <div>
                    <p class="text-xs text-gray-500 mb-1 font-bold text-teal-600">
                        <i class="fa-solid fa-crown text-yellow-400 mr-1"></i>歷史最低對比價 (每單位)
                    </p>
                    <div class="flex items-end gap-2">
                        <span class="text-3xl font-bold text-teal-600" id="detail-min-price">--</span>
                        <span class="text-sm text-gray-400 mb-1" id="detail-min-unit">元 / 單位</span>
                    </div>
                </div>
                <button onclick="analyzePriceHistory()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-indigo-200 transition-colors btn-active">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 智能分析
                </button>
            </div>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="price-history-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Price -->
            <button onclick="openModal('modal-add-price')" class="absolute bottom-6 right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- MODAL: Add Product -->
        <div id="modal-add-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">新增商品</h2>
                <input type="text" id="input-product-name" placeholder="例如：雞蛋、衛生紙..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="addProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">新增</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Edit Product Name -->
        <div id="modal-edit-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">修改商品名稱</h2>
                <input type="text" id="input-edit-product-name" placeholder="輸入新的名稱..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="saveEditProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">儲存</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Add Price (Unit Price Comparison Focused) -->
        <div id="modal-add-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">記一筆價格 (統一對比)</h2>
                    <p class="text-sm text-orange-600 font-medium">重量: /g, 物品: /件</p>
                </div>
                
                <!-- 總價與單位輸入 -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">原始價格數值 (總價)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-raw-price" placeholder="例如: 99.9 或 25000 (總價)" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                        <select id="input-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-orange-500" onchange="toggleQuantityInput(this.value)">
                            <option value="" disabled selected>請選單位</option>
                            <option value="per_item">元 / 件 (每件/每包裝)</option>
                            <option value="per_g">元 / g (每克)</option>
                            <option value="per_100g">元 / 100g (每百克)</option>
                            <option value="per_kg">元 / kg (每公斤)</option>
                            <option value="per_lb">元 / lb (每磅)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="add-error-message"></p>
                </div>

                <!-- 組合數量輸入 (針對 "元 / 件" 類型顯示) -->
                <div id="quantity-group" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-orange-500"></i> 數量 (包裝內實際件數)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-price-quantity" placeholder="例如: 3 (若為 $100/3 件)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">地點 (選填)</label>
                    <input type="text" id="input-price-location" placeholder="例如: 全聯/Costco" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">備註 (選填)</label>
                    <input type="text" id="input-price-note" placeholder="例如：會員特價/促銷活動..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="addPrice()" class="px-6 py-2 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 shadow-md btn-active transition-colors">計算並儲存</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Edit Price -->
        <div id="modal-edit-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-800">編輯價格紀錄</h2>
                
                <!-- 價格與單位輸入 (編輯模式) -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">原始價格數值 (總價)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-edit-raw-price" placeholder="0" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                        <select id="input-edit-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-teal-500" onchange="toggleQuantityInputEdit(this.value)">
                            <option value="per_item">元 / 件 (每件/每包裝)</option>
                            <option value="per_g">元 / g (每克)</option>
                            <option value="per_100g">元 / 100g (每百克)</option>
                            <option value="per_kg">元 / kg (每公斤)</option>
                            <option value="per_lb">元 / lb (每磅)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="edit-error-message"></p>
                </div>

                 <!-- 組合數量輸入 (編輯模式) -->
                <div id="quantity-group-edit" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-teal-500"></i> 數量 (包裝內實際件數)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-edit-price-quantity" placeholder="例如: 3 (若為 $100/3 件)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">地點 (選填)</label>
                    <input type="text" id="input-edit-price-location" placeholder="例如: 全聯" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">備註 (選填)</label>
                    <input type="text" id="input-edit-price-note" placeholder="例如：會員特價..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="saveEditPrice()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">儲存修改</button>
                </div>
            </div>
        </div>

        <!-- MODAL: AI Analysis -->
        <div id="modal-ai-result" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI 分析報告
                    </h2>
                    <button onclick="closeModal('modal-ai-result')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div id="ai-result-content" class="prose text-sm">
                    <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                        <div class="loader mb-3"></div>
                        <p>Gemini 正在分析數據中...</p>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeModal('modal-ai-result')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm">關閉</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase Imports (SDK已包含在此)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Constants
        const apiKey = "AIzaSyAt4beTHAZG7TaWTz8RPgPdk-zpwg_s9P1"; 
        const LB_TO_G = 453.592; // 1 磅約等於 453.592 克

        // --- 解決連線問題的核心代碼 ---
        
        // 1. 手動定義您的 Firebase 配置 (來自您提供的截圖)
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAt4beTHAZG7TaWTz8RPgPdk-zpwg_s9P1",
            authDomain: "coffee-spark-ai-barista-3a436.firebaseapp.com",
            projectId: "coffee-spark-ai-barista-3a436",
            storageBucket: "coffee-spark-ai-barista-3a436.firebasestorage.app",
            messagingSenderId: "367965659562",
            appId: "1:367965659562:web:6678c57dd8871f1fed8bd3",
            measurementId: "G-4F2SXN14VM"
        };
        
        // 2. 優先使用系統提供的配置，如果沒有，則使用您手動提供的配置
        const environmentConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = Object.keys(environmentConfig).length > 0 ? environmentConfig : USER_FIREBASE_CONFIG;
        
        // 其他必要的全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ------------------------------------
        
        // Firebase Services
        let db;
        let auth;
        let userId = 'loading'; // Will be set after auth
        let isAuthReady = false;
        
        
        // --- State Management ---
        let products = [];
        let currentProductId = null;
        let currentSearchTerm = '';
        let editingPriceId = null; 

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

        function dismissLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 500);
            }
        }

        function setLoaderStatus(text, isError = false) {
             document.getElementById('loading-text').textContent = text;
             const spinner = document.getElementById('loading-spinner');
             if (isError) {
                spinner.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i>';
                spinner.classList.remove('loader');
             } else {
                spinner.classList.add('loader');
                spinner.innerHTML = '';
             }
        }

        function initApp() {
            setLogLevel('Debug');
            
            // 檢查 Firebase 配置是否存在
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase Config is missing. Cannot proceed with cloud sync.");
                setLoaderStatus("錯誤：缺少 Firebase 配置，無法同步", true);
                document.getElementById('user-sync-info').textContent = "同步狀態: 缺少配置";
                // 立即移除載入畫面，顯示錯誤
                setTimeout(dismissLoader, 3000); 
                return; 
            }
            
            // 如果配置存在，開始初始化 Firebase 服務
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch(e) {
                console.error("Firebase Initialization Failed:", e);
                setLoaderStatus("錯誤：Firebase 初始化失敗", true);
                document.getElementById('user-sync-info').textContent = "同步狀態: 初始化失敗";
                setTimeout(dismissLoader, 3000); 
                return;
            }

            // 設置 Auth 狀態監聽器
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 認證成功
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-sync-info').textContent = `已同步 (用戶ID: ${userId})`;
                    listenToProducts(); // 認證完成後，開始監聽資料
                    dismissLoader();

                } else if (!isAuthReady) {
                    // 處理首次登入或匿名登入
                    setLoaderStatus("正在進行使用者認證...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign-In Error:", error);
                        setLoaderStatus("認證失敗，請檢查配置和網路", true);
                        document.getElementById('user-sync-info').textContent = "連線失敗，請檢查配置";
                        setTimeout(dismissLoader, 3000);
                    }
                }
            });
        }
        
        /** 取得 Firestore 收藏路徑 */
        function getProductsCollectionRef() {
            if (!db || !userId) return null;
            // 使用 private path: /artifacts/{appId}/users/{userId}/products
            return collection(db, `artifacts/${appId}/users/${userId}/products`);
        }

        /** 取得 Firestore 文件路徑 */
        function getProductDocRef(productId) {
            const colRef = getProductsCollectionRef();
            return colRef ? doc(colRef, String(productId)) : null;
        }

        /**
         * 實時監聽產品列表 (替代 loadData)
         */
        function listenToProducts() {
            const colRef = getProductsCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                products = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // 將 prices 陣列反序列化 (如果需要)
                    // 注意：Firestore 讀取/寫入整個 products 陣列時，陣列中的物件可以被直接儲存。
                    products.push({
                        id: doc.id,
                        name: data.name,
                        prices: data.prices || [] // Ensure prices is an array
                    });
                });
                renderProductList();

                // 如果在詳細頁面，且資料有更新，重新渲染詳細頁面
                if (currentProductId) {
                    const productExists = products.some(p => p.id === currentProductId);
                    if (productExists) {
                        renderProductDetail();
                    } else {
                        // 當前商品被刪除時，跳回主頁
                        goHome();
                    }
                }
            }, (error) => {
                console.error("Firestore listen error: ", error);
                document.getElementById('user-sync-info').textContent = "同步失敗，資料庫存取錯誤";
            });
        }


        // --- UI Helpers ---

        function toggleQuantityInput(unit, mode = 'add') {
            const quantityGroupEl = document.getElementById(mode === 'add' ? 'quantity-group' : 'quantity-group-edit');
            if (unit === 'per_item') {
                quantityGroupEl.style.display = 'block';
            } else {
                quantityGroupEl.style.display = 'none';
                document.getElementById(mode === 'add' ? 'input-price-quantity' : 'input-edit-price-quantity').value = 1;
            }
        }
        function toggleQuantityInputEdit(unit) {
            toggleQuantityInput(unit, 'edit');
        }

        // --- Core Price Conversion Logic (Same as before) ---
        function calculateStandardPrice(price, unit, quantity = 1) {
            if (isNaN(price) || price <= 0) return { standardPrice: 0, standardUnitLabel: 'N/A' };
            if (unit === 'per_item' && (isNaN(quantity) || quantity <= 0)) {
                quantity = 1; 
            }

            let standardPrice = 0;
            let standardUnitLabel = 'N/A';

            switch (unit) {
                case 'per_item':
                    standardPrice = price / quantity;
                    standardUnitLabel = '件';
                    break;
                case 'per_g':
                    standardPrice = price;
                    standardUnitLabel = 'g';
                    break;
                case 'per_100g':
                    standardPrice = price / 100;
                    standardUnitLabel = 'g';
                    break;
                case 'per_kg':
                    standardPrice = price / 1000;
                    standardUnitLabel = 'g';
                    break;
                case 'per_lb':
                    standardPrice = price / LB_TO_G;
                    standardUnitLabel = 'g';
                    break;
                default:
                    return { standardPrice: 0, standardUnitLabel: 'N/A' };
            }
            
            const precision = standardUnitLabel === 'g' ? 4 : 2;
            return { 
                standardPrice: parseFloat(standardPrice.toFixed(precision)), 
                standardUnitLabel: standardUnitLabel 
            };
        }
        
        // --- Navigation / Modal Logic ---

        function goDetail(id) {
            currentProductId = id;
            renderProductDetail();
            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
        }

        function goHome() {
            currentProductId = null;
            renderProductList();
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('page-home').classList.add('active');
        }

        function openEditModal() {
            const product = products.find(p => p.id === currentProductId);
            if (product) {
                document.getElementById('input-edit-product-name').value = product.name;
                openModal('modal-edit-product');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
            
            if (modalId === 'modal-add-price') {
                document.getElementById('input-raw-price').value = '';
                document.getElementById('input-price-unit').value = ''; 
                document.getElementById('input-price-quantity').value = 1; 
                document.getElementById('input-price-note').value = '';
                document.getElementById('input-price-location').value = '';
                document.getElementById('add-error-message').textContent = '';
                document.getElementById('quantity-group').style.display = 'none'; 
                setTimeout(() => document.getElementById('input-raw-price').focus(), 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function handleSearch(value) {
            currentSearchTerm = value.trim().toLowerCase();
            renderProductList();
        }

        // --- Firestore CRUD Operations ---

        async function addProduct() {
            if (!isAuthReady) return;

            const name = document.getElementById('input-product-name').value.trim();
            if (!name) return;

            try {
                // 使用 setDoc 並指定一個新的 ID (Date.now())，以便於後續查找和刪除
                const newProductId = Date.now();
                const newProductRef = getProductDocRef(newProductId);

                await setDoc(newProductRef, { 
                    name: name, 
                    prices: [] 
                });
                
                closeModal('modal-add-product');
                // listenToProducts 會自動更新 UI
            } catch (e) {
                console.error("Error adding document: ", e);
                // 應顯示錯誤訊息給用戶
            }
        }
        
        async function deleteCurrentProduct() {
            if (!isAuthReady) return;

            // 為了簡潔，使用瀏覽器內建的確認框 (實際應用中應使用客製化 Modal)
            if(!confirm(`確定要刪除商品 "${document.getElementById('detail-title').textContent}" 及其所有價格紀錄嗎？`)) return;

            try {
                const productRef = getProductDocRef(currentProductId);
                if (productRef) {
                    await deleteDoc(productRef);
                    goHome();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        async function saveEditProduct() {
            if (!isAuthReady) return;

            const newName = document.getElementById('input-edit-product-name').value.trim();
            if (!newName) return;

            try {
                const productRef = getProductDocRef(currentProductId);
                if (productRef) {
                    await setDoc(productRef, { name: newName }, { merge: true });
                    closeModal('modal-edit-product');
                    // listenToProducts 會自動更新 UI
                }
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }
        
        async function addPrice() {
            if (!isAuthReady) return;

            const rawPrice = parseFloat(document.getElementById('input-raw-price').value);
            const rawUnit = document.getElementById('input-price-unit').value;
            let rawQuantity = parseFloat(document.getElementById('input-price-quantity').value); 
            const note = document.getElementById('input-price-note').value.trim();
            const location = document.getElementById('input-price-location').value.trim();
            const errorMsgEl = document.getElementById('add-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(rawPrice) || rawPrice <= 0) { 
                errorMsgEl.textContent = "請輸入有效的價格數值 (總價)"; return; 
            }
            if (!rawUnit) {
                errorMsgEl.textContent = "請選擇原始價格單位"; return; 
            }
            if (rawUnit === 'per_item') {
                if (isNaN(rawQuantity) || rawQuantity <= 0) {
                     errorMsgEl.textContent = "請輸入有效的數量 (件數)"; return; 
                }
            } else {
                rawQuantity = 1; 
            }
            
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(rawPrice, rawUnit, rawQuantity);
            const product = products.find(p => p.id === currentProductId);

            if (product) {
                const newPriceEntry = { 
                    id: crypto.randomUUID(), // 使用 UUID 作為價格紀錄的唯一 ID
                    rawPrice, 
                    rawUnit,
                    rawQuantity,            
                    standardPrice,          
                    standardUnitLabel,      
                    date: new Date().toISOString(), // Use ISO string for reliable sorting/storage
                    note, 
                    location, 
                };
                
                // 將新的價格紀錄加入到現有的 prices 陣列中
                const newPrices = [newPriceEntry, ...(product.prices || [])];

                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    closeModal('modal-add-price');
                    // listenToProducts 會自動更新 UI
                } catch (e) {
                    console.error("Error adding price: ", e);
                }
            }
        }

        async function deletePrice(priceId) {
            if (!isAuthReady) return;

            // 為了簡潔，使用瀏覽器內建的確認框
            if(!confirm("確定要刪除這筆價格紀錄嗎？")) return;
            
            const product = products.find(p => p.id === currentProductId);
            if (product) {
                const newPrices = product.prices.filter(p => p.id !== priceId);

                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    // listenToProducts 會自動更新 UI
                } catch (e) {
                    console.error("Error deleting price: ", e);
                }
            }
        }

        function openEditPriceModal(priceId) {
            const product = products.find(p => p.id === currentProductId);
            const entry = product ? product.prices.find(p => p.id === priceId) : null;

            if (!entry) return;
            editingPriceId = priceId;

            document.getElementById('input-edit-raw-price').value = entry.rawPrice;
            document.getElementById('input-edit-price-unit').value = entry.rawUnit;
            document.getElementById('input-edit-price-note').value = entry.note;
            document.getElementById('input-edit-price-location').value = entry.location;
            document.getElementById('edit-error-message').textContent = '';
            
            document.getElementById('input-edit-price-quantity').value = entry.rawQuantity ?? 1;
            
            toggleQuantityInputEdit(entry.rawUnit);
            openModal('modal-edit-price');
        }

        async function saveEditPrice() {
            if (!isAuthReady || !editingPriceId) return;

            const newRawPrice = parseFloat(document.getElementById('input-edit-raw-price').value);
            const newRawUnit = document.getElementById('input-edit-price-unit').value;
            let newRawQuantity = parseFloat(document.getElementById('input-edit-price-quantity').value); 
            const newNote = document.getElementById('input-edit-price-note').value.trim();
            const newLocation = document.getElementById('input-edit-price-location').value.trim();
            const errorMsgEl = document.getElementById('edit-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(newRawPrice) || newRawPrice <= 0) { 
                errorMsgEl.textContent = "請輸入有效的價格數值 (總價)"; return; 
            }

            if (newRawUnit === 'per_item') {
                if (isNaN(newRawQuantity) || newRawQuantity <= 0) {
                     errorMsgEl.textContent = "請輸入有效的數量 (件數)"; return; 
                }
            } else {
                newRawQuantity = 1; 
            }
            
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(newRawPrice, newRawUnit, newRawQuantity);


            const product = products.find(p => p.id === currentProductId);
            if (product) {
                // 找出要更新的價格紀錄，並建立新的 prices 陣列
                const newPrices = product.prices.map(p => {
                    if (p.id === editingPriceId) {
                        return {
                            ...p,
                            rawPrice: newRawPrice,
                            rawUnit: newRawUnit,
                            rawQuantity: newRawQuantity,
                            note: newNote,
                            location: newLocation,
                            standardPrice: standardPrice,
                            standardUnitLabel: standardUnitLabel,
                        };
                    }
                    return p;
                });
                
                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    
                    closeModal('modal-edit-price');
                    editingPriceId = null;
                    // listenToProducts 會自動更新 UI
                } catch (e) {
                    console.error("Error saving price edit: ", e);
                }
            }
        }


        // --- Render UI (Same as before) ---
        function renderProductList() {
            const container = document.getElementById('product-list-container');
            // 將產品列表按 ID 排序 (最新新增的在前)
            const sortedProducts = [...products].sort((a, b) => parseInt(b.id) - parseInt(a.id));
            const filtered = sortedProducts.filter(p => p.name.toLowerCase().includes(currentSearchTerm));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><p>找不到商品</p><p class="text-sm">點擊右下角新增</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(product => {
                const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;
                
                let priceDisplay = `<span class="text-gray-400 text-sm">無價格</span>`;

                if (minEntry) {
                    const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                    const unitText = minEntry.standardUnitLabel === 'g' ? '克' : '件';
                    
                    priceDisplay = `
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-gray-400">最低/ ${unitText}</span>
                            <span class="text-teal-600 font-bold text-lg">$${priceFormatted}</span>
                        </div>`; 
                }

                return `
                <div onclick="goDetail('${product.id}')" class="bg-white p-4 rounded-xl shadow-sm mb-3 flex justify-between items-center btn-active cursor-pointer border-l-4 border-teal-500">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${product.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">紀錄: ${product.prices.length} 筆</p>
                    </div>
                    <div class="flex items-center">${priceDisplay}<i class="fa-solid fa-chevron-right text-gray-300 ml-3"></i></div>
                </div>`;
            }).join('');
        }

        function getUnitLabel(unit) {
             switch (unit) {
                case 'per_item': return '元 / 件 (每件/包裝)';
                case 'per_g': return '元 / g (每克)';
                case 'per_100g': return '元 / 100g (每百克)';
                case 'per_kg': return '元 / kg (每公斤)';
                case 'per_lb': return '元 / lb (每磅)';
                default: return '未知單位';
            }
        }

        function renderProductDetail() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;

            document.getElementById('detail-title').textContent = product.name;
            const minPriceEl = document.getElementById('detail-min-price');
            const minUnitEl = document.getElementById('detail-min-unit');
            
            const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;

            if (minEntry) {
                const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                minPriceEl.textContent = priceFormatted;
                minUnitEl.textContent = `元 / ${minEntry.standardUnitLabel}`;
            } else {
                minPriceEl.textContent = '--';
                minUnitEl.textContent = '元 / 單位';
            }


            const container = document.getElementById('price-history-container');
            // 將價格紀錄按日期排序（最新在前）
            product.prices.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (product.prices.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><p>尚無紀錄</p></div>`;
                return;
            }

            container.innerHTML = product.prices.map((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
                
                let diffHtml = '';
                let diffPrecision = entry.standardUnitLabel === 'g' ? 4 : 2; 
                
                if (index < product.prices.length - 1) {
                    const prevEntry = product.prices[index + 1];
                    if (entry.standardUnitLabel === prevEntry.standardUnitLabel) {
                        const diff = entry.standardPrice - prevEntry.standardPrice;
                        if (diff > 0) diffHtml = `<span class="text-red-500 text-xs ml-2">▲ ${diff.toFixed(diffPrecision)}</span>`;
                        else if (diff < 0) diffHtml = `<span class="text-green-500 text-xs ml-2">▼ ${Math.abs(diff).toFixed(diffPrecision)}</span>`;
                    }
                }

                const unitLabel = getUnitLabel(entry.rawUnit);
                
                const priceFormatted = entry.standardUnitLabel === 'g' ? entry.standardPrice.toFixed(4) : entry.standardPrice.toFixed(2);
                const standardUnitText = entry.standardUnitLabel === 'g' ? `g (每克對比價)` : `件 (每件對比價)`;

                const quantityText = entry.rawUnit === 'per_item' && entry.rawQuantity > 1 
                                     ? ` (共 ${entry.rawQuantity} 件)` 
                                     : '';
                
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-2 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <!-- 顯示統一的標準化價格 (最重要) -->
                            <span class="text-xl font-bold text-teal-600">$${priceFormatted}</span>
                            <span class="text-sm font-medium text-teal-500 ml-1">/ ${standardUnitText}</span>
                            ${diffHtml}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">原始輸入: 總價 $${entry.rawPrice} (${unitLabel})${quantityText}</p>
                        
                        ${entry.location ? `<p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-location-dot mr-1 text-teal-500"></i>${entry.location}</p>` : ''}
                        ${entry.note ? `<p class="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">${entry.note}</p>` : ''}
                    </div>
                    <div class="text-right whitespace-nowrap ml-2 flex flex-col items-end">
                        <p class="text-xs text-gray-400">${dateStr}</p>
                        <div class="mt-2 flex gap-2">
                             <button onclick="openEditPriceModal('${entry.id}')" class="text-teal-500 hover:text-teal-700 text-sm p-1 btn-active" title="編輯紀錄"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button onclick="deletePrice('${entry.id}')" class="text-red-400 hover:text-red-600 text-sm p-1 btn-active" title="刪除紀錄"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- AI Analysis (Mocked) ---
        async function analyzePriceHistory() {
            // This function is mocked as API calls are not supported in this environment without an actual key.
            // The structure is kept for demonstration.
            const product = products.find(p => p.id === currentProductId);
            if (!product || product.prices.length === 0) {
                // 應使用客製化 Modal 而非 console.warn/alert
                console.warn("請先新增一些價格紀錄，AI 才能進行分析喔！"); 
                return;
            }

            openModal('modal-ai-result');
            const container = document.getElementById('ai-result-content');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                    <div class="loader mb-3"></div>
                    <p>Gemini 正在分析 ${product.name} 的價格走勢...</p>
                </div>`;

            await new Promise(r => setTimeout(r, 2000)); // Simulate delay
            
            const historyData = product.prices.slice(0, 5).map(p => ({
                date: new Date(p.date).toLocaleDateString(),
                price: p.standardPrice.toFixed(p.standardUnitLabel === 'g' ? 4 : 2), 
                unit: p.standardUnitLabel,
                location: p.location,
                rawQuantity: p.rawQuantity,
            }));

            // Mocked Analysis Result
            const unitType = product.prices[0].standardUnitLabel === 'g' ? '每克' : '每件';
            const lowestPrice = Math.min(...product.prices.map(p => p.standardPrice)).toFixed(unitType === '每克' ? 4 : 2);
            const highestPrice = Math.max(...product.prices.map(p => p.standardPrice)).toFixed(unitType === '每克' ? 4 : 2);

            const mockAnalysis = `
### 🤖 ${product.name} 價格走勢分析

這是根據您最新的 ${product.prices.length} 筆紀錄得出的分析：

**1. 價格評估**

* **歷史最低對比價：** \`${lowestPrice} 元 / ${unitType}\`
* **歷史最高對比價：** \`${highestPrice} 元 / ${unitType}\`

目前的價格波動區間明顯，您最新的價格是... (略)

**2. 走勢分析**

根據最近五筆紀錄：
\`\`\`json
${JSON.stringify(historyData, null, 2)}
\`\`\`

總體而言，價格趨勢 (略)...

**3. 購買建議**

建議您在 **促銷活動 (如組合裝)** 時購入，因為這通常能將 **每單位價格** 拉低至歷史最低點附近。例如，當您看到 **3件/100元** 的促銷時，其單件價格 \`${(100/3).toFixed(2)} 元/件\` 遠低於單件原價。

---
*提示: 這是模擬分析結果，因為 AI 服務在當前環境中不可用。*
`;
            
            container.innerHTML = marked.parse(mockAnalysis);
        }

        // --- FIX: Expose functions to global scope for HTML inline handlers ---
        window.goDetail = goDetail;
        window.goHome = goHome;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.handleSearch = handleSearch;
        window.openEditModal = openEditModal;
        window.deleteCurrentProduct = deleteCurrentProduct;
        window.analyzePriceHistory = analyzePriceHistory;
        window.addProduct = addProduct;
        window.saveEditProduct = saveEditProduct;
        window.addPrice = addPrice;
        window.deletePrice = deletePrice;
        window.openEditPriceModal = openEditPriceModal;
        window.saveEditPrice = saveEditPrice;
        window.toggleQuantityInput = toggleQuantityInput;
        window.toggleQuantityInputEdit = toggleQuantityInputEdit;
        // --- END FIX ---

    </script>
</body>
</html>
