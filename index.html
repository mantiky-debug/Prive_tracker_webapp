import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  collection, 
  query, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  serverTimestamp 
} from 'firebase/firestore';
import { Plus, X, Trash2, Edit2, Search } from 'lucide-react';

// --- Global Variables Provided by Canvas Environment (MANDATORY USE) ---
// Note: These variables must be accessed using window scope to ensure availability.
const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
const firebaseConfig = typeof window.__firebase_config !== 'undefined' 
  ? JSON.parse(window.__firebase_config) 
  : null;
const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' 
  ? window.__initial_auth_token 
  : null;
// -----------------------------------------------------------------------

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [products, setProducts] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [currentProduct, setCurrentProduct] = useState(null); // For editing
  
  const [name, setName] = useState('');
  const [price, setPrice] = useState('');
  const [unitAmount, setUnitAmount] = useState('');
  const [unitType, setUnitType] = useState('g'); // Default to gram

  const statusMessage = useMemo(() => {
    if (!firebaseConfig) return '連線失敗，請檢查配置 (缺少 Firebase Config)';
    if (!isAuthReady) return '正在連線雲端資料庫...';
    if (!userId) return '連線失敗，請檢查配置 (無法獲取用戶ID)';
    return `已同步 (用戶ID: ${userId.substring(0, 8)}...)`;
  }, [firebaseConfig, isAuthReady, userId]);

  // --- 1. INITIALIZATION and AUTHENTICATION ---
  useEffect(() => {
    if (!firebaseConfig) {
      console.error("Firebase configuration is missing.");
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const userAuth = getAuth(app);
      
      setDb(firestore);
      setAuth(userAuth);
      
      // Set up authentication listener
      const unsubscribe = onAuthStateChanged(userAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
          setIsAuthReady(true);
          console.log("Authentication successful. UID:", user.uid);
        } else {
          // If no user is signed in, force sign in
          try {
             if (initialAuthToken) {
                // Use custom token if provided
                await signInWithCustomToken(userAuth, initialAuthToken);
             } else {
                // Otherwise, sign in anonymously
                await signInAnonymously(userAuth);
             }
             // onAuthStateChanged will trigger again with the new user
          } catch (error) {
            console.error("Authentication failed:", error);
            setIsAuthReady(true); // Stop loading even if auth fails
            setUserId(null); 
          }
        }
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase initialization failed:", e);
      setIsAuthReady(true);
    }
  }, [initialAuthToken]); // Rerun only if the initialAuthToken changes

  // --- Helper: Calculate Unit Price ---
  const calculateUnitPrice = useCallback((price, unitAmount, unitType) => {
    const p = parseFloat(price);
    const u = parseFloat(unitAmount);
    if (isNaN(p) || isNaN(u) || u <= 0) return { price: 0, unit: 'N/A' };
    
    let baseUnit = 1;
    let displayUnit = unitType;

    if (unitType === 'kg') {
      baseUnit = 1000;
      displayUnit = 'g';
    } else if (unitType === 'L') {
      baseUnit = 1000;
      displayUnit = 'mL';
    } else if (unitType === 'mL') {
      // Keep as mL, convert to L for comparison base
    } else if (unitType === 'count') {
      baseUnit = 1;
      displayUnit = '件';
    }

    const pricePerBaseUnit = (p / u) * baseUnit;
    
    // Round to 3 decimal places for accuracy
    return { 
      price: pricePerBaseUnit.toFixed(3), 
      unit: `${displayUnit}`
    };
  }, []);

  // --- 2. DATA LISTENER (FIRESTORE) ---
  useEffect(() => {
    // Guard clause: Do not fetch data until authentication is ready and userId is known
    if (!isAuthReady || !db || !userId) {
      if (isAuthReady && !userId) {
        console.error("Authentication ready but userId is null. Cannot query Firestore.");
      }
      return;
    }

    // Construct the collection path for the current user's private data
    // Path: /artifacts/{appId}/users/{userId}/products
    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
    
    // Set up real-time listener
    const q = query(productsCollectionRef);
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const productList = snapshot.docs.map(doc => {
        const data = doc.data();
        const { price, unit } = calculateUnitPrice(data.price, data.unitAmount, data.unitType);
        return {
          id: doc.id,
          ...data,
          unitPrice: price,
          unitDisplay: unit
        };
      });
      
      // Sort by Unit Price (ascending)
      productList.sort((a, b) => parseFloat(a.unitPrice) - parseFloat(b.unitPrice));
      
      setProducts(productList);
    }, (error) => {
      console.error("Firestore snapshot listener failed:", error);
      // Display a connection error to the user via status message if necessary
    });

    return () => unsubscribe(); // Cleanup listener on component unmount or dependency change
  }, [db, userId, isAuthReady, appId, calculateUnitPrice]);

  // --- Form Handlers ---

  const resetForm = () => {
    setName('');
    setPrice('');
    setUnitAmount('');
    setUnitType('g');
    setCurrentProduct(null);
  };

  const openAddModal = () => {
    resetForm();
    setShowModal(true);
  };
  
  const openEditModal = (product) => {
    setCurrentProduct(product);
    setName(product.name);
    setPrice(String(product.price));
    setUnitAmount(String(product.unitAmount));
    setUnitType(product.unitType);
    setShowModal(true);
  };

  const handleSaveProduct = async (e) => {
    e.preventDefault();
    if (!db || !userId) {
      console.error("Database not ready or User not authenticated.");
      return;
    }

    const priceValue = parseFloat(price);
    const unitAmountValue = parseFloat(unitAmount);

    if (!name || isNaN(priceValue) || isNaN(unitAmountValue) || unitAmountValue <= 0) {
      alert('請填寫所有欄位並確保價格和數量有效。');
      return;
    }

    const productData = {
      name: name.trim(),
      price: priceValue,
      unitAmount: unitAmountValue,
      unitType: unitType,
      timestamp: serverTimestamp()
    };
    
    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);

    try {
      if (currentProduct) {
        // Update existing product
        const docRef = doc(productsCollectionRef, currentProduct.id);
        await updateDoc(docRef, productData);
        console.log("Document successfully updated!");
      } else {
        // Add new product
        await addDoc(productsCollectionRef, productData);
        console.log("Document successfully added!");
      }
      setShowModal(false);
      resetForm();
    } catch (e) {
      console.error("Error saving document: ", e);
      alert(`儲存失敗: ${e.message}`);
    }
  };

  const handleDeleteProduct = async (id, name) => {
    // Custom modal confirmation instead of window.confirm()
    if (!db || !userId) return;

    // A simple, visible confirmation UI (not a real modal, but better than alert/confirm)
    const confirmed = window.confirm(`確定要刪除商品「${name}」嗎？`);
    if (confirmed) {
      try {
        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
        const docRef = doc(productsCollectionRef, id);
        await deleteDoc(docRef);
        console.log("Document successfully deleted!");
      } catch (e) {
        console.error("Error removing document: ", e);
        alert(`刪除失敗: ${e.message}`);
      }
    }
  };

  // --- Filtering ---
  const filteredProducts = products.filter(product => 
    product.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // --- UI Components ---

  const Header = () => (
    <div className="bg-teal-600 p-4 text-white shadow-lg">
      <div className="text-xl font-bold tracking-wider">⚖️ 價格對比追蹤 (雲端版)</div>
      <div className="text-sm opacity-90 mt-1">統一換算為 每單位價格 (克/毫升/件) 進行比較</div>
    </div>
  );
  
  const StatusFooter = () => (
    <div className="fixed bottom-0 left-0 right-0 p-2 text-center text-xs bg-gray-100 border-t border-gray-300">
      <span className={isAuthReady && userId ? "text-green-600" : "text-red-500"}>
        {statusMessage}
      </span>
    </div>
  );

  const SearchBar = () => (
    <div className="p-4 flex items-center bg-white shadow-md rounded-lg mx-4 mt-4">
      <Search className="text-gray-400 w-5 h-5 mr-2" />
      <input
        type="text"
        placeholder="搜尋商品名稱..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        className="w-full focus:outline-none text-gray-700 placeholder-gray-400"
      />
    </div>
  );

  const ProductList = () => (
    <div className="p-4 space-y-3 pb-24"> {/* Added pb-24 for footer padding */}
      {filteredProducts.length === 0 && !searchQuery ? (
        <p className="text-center text-gray-500 pt-8">
          點擊右下角 '+' 新增您的第一個商品，開始追蹤！
        </p>
      ) : filteredProducts.length === 0 && searchQuery ? (
         <p className="text-center text-gray-500 pt-8">
          找不到符合 "{searchQuery}" 的商品。
        </p>
      ) : (
        filteredProducts.map((product, index) => (
          <div 
            key={product.id} 
            className={`
              p-4 rounded-xl shadow-lg transition-all duration-300 ease-in-out 
              ${index === 0 ? 'bg-yellow-50 border-2 border-yellow-400' : 'bg-white border border-gray-200'}
            `}
          >
            <div className="flex justify-between items-start mb-1">
              <h3 className="font-bold text-lg text-gray-800 break-words pr-2">{product.name}</h3>
              <div className="flex space-x-2">
                <button 
                  onClick={() => openEditModal(product)}
                  className="p-1 text-blue-500 hover:text-blue-700 transition duration-150"
                  aria-label="編輯商品"
                >
                  <Edit2 className="w-5 h-5" />
                </button>
                <button 
                  onClick={() => handleDeleteProduct(product.id, product.name)}
                  className="p-1 text-red-500 hover:text-red-700 transition duration-150"
                  aria-label="刪除商品"
                >
                  <Trash2 className="w-5 h-5" />
                </button>
              </div>
            </div>
            
            <div className="flex justify-between items-end mt-2">
              <div>
                <p className="text-2xl font-extrabold text-teal-700">
                  ${product.unitPrice}
                  <span className="text-sm font-normal text-gray-500 ml-1">/{product.unitDisplay}</span>
                </p>
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-600">總價: ${product.price}</p>
                <p className="text-xs text-gray-500">數量: {product.unitAmount} {product.unitType}</p>
              </div>
            </div>
          </div>
        ))
      )}
    </div>
  );

  const Modal = () => {
    const title = currentProduct ? '編輯商品' : '新增商品';
    
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm m-4 transform transition-all scale-100 opacity-100">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
            <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-gray-600 transition">
              <X className="w-6 h-6" />
            </button>
          </div>
          <form onSubmit={handleSaveProduct}>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">商品名稱</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"
                placeholder="例如：有機牛奶"
              />
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">總價格 ($)</label>
              <input
                type="number"
                step="0.01"
                value={price}
                onChange={(e) => setPrice(e.target.value)}
                required
                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"
                placeholder="例如：35.90"
              />
            </div>
            
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">數量</label>
                <input
                  type="number"
                  step="0.01"
                  value={unitAmount}
                  onChange={(e) => setUnitAmount(e.target.value)}
                  required
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"
                  placeholder="例如：900"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">單位</label>
                <select
                  value={unitType}
                  onChange={(e) => setUnitType(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 appearance-none bg-white"
                >
                  <option value="g">克 (g)</option>
                  <option value="kg">公斤 (kg)</option>
                  <option value="mL">毫升 (mL)</option>
                  <option value="L">公升 (L)</option>
                  <option value="count">件 (Count)</option>
                </select>
              </div>
            </div>
            
            <button 
              type="submit" 
              className="w-full bg-teal-600 text-white p-3 rounded-lg font-semibold hover:bg-teal-700 transition duration-200 shadow-md"
            >
              儲存
            </button>
          </form>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans antialiased">
      <script src="https://cdn.tailwindcss.com"></script>
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
          body { font-family: 'Inter', sans-serif; }
          .min-h-screen { min-height: 100vh; }
          .fab-button {
            transition: transform 0.2s, box-shadow 0.2s;
          }
          .fab-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(6, 95, 87, 0.5), 0 4px 6px -2px rgba(6, 95, 87, 0.25);
          }
        `}
      </style>

      <Header />
      <SearchBar />
      
      {/* Loading/Error state indicator */}
      {!isAuthReady && (
        <div className="flex flex-col items-center justify-center p-12">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-teal-500 border-t-transparent mb-4"></div>
          <p className="text-teal-600 font-medium">正在連線並認證...</p>
        </div>
      )}

      {/* Main Content */}
      {isAuthReady && (
        <ProductList />
      )}
      
      {/* Floating Action Button */}
      <button 
        onClick={openAddModal} 
        className="fab-button fixed bottom-8 right-8 bg-teal-600 text-white p-4 rounded-full shadow-xl hover:bg-teal-700"
        aria-label="新增商品"
      >
        <Plus className="w-6 h-6" />
      </button>

      {/* Status Bar */}
      <StatusFooter />

      {/* Modal */}
      {showModal && <Modal />}
    </div>
  );
};

export default App;
