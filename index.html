<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>價格追蹤小幫手 - 每單位彈性對比</title>
    <!-- PWA Optimization Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: none;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-bottom: 0.5rem; color: #111827; }
        .prose p { margin-bottom: 0.5rem; line-height: 1.6; color: #374151; }
        .prose strong { color: #0d9488; font-weight: 700; }
        /* Hide quantity field by default for weight items */
        #quantity-group { display: none; }
        #modal-add-price .group-item-only {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div class="relative w-full h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden">
        
        <!-- PAGE 1: Home (Product List) -->
        <div id="page-home" class="page active">
            <header class="bg-teal-600 text-white p-4 shadow-md z-20 sticky top-0">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced"></i> 價格對比追蹤
                </h1>
                <p class="text-sm text-teal-200 mt-1">統一換算為 <span class="font-bold">每單位價格 (克或件)</span> 進行比較</p>
                <!-- Search -->
                <div class="relative mt-3">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="搜尋商品名稱..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-300 shadow-inner"
                        oninput="handleSearch(this.value)">
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="product-list-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Product -->
            <button onclick="openModal('modal-add-product')" class="absolute bottom-6 right-6 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-teal-700 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- PAGE 2: Detail (Price History) -->
        <div id="page-detail" class="page">
            <header class="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3 z-20 sticky top-0">
                <button onclick="goHome()" class="text-white p-2 -ml-2 btn-active">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold truncate flex-1" id="detail-title">商品名稱</h1>
                <div class="flex gap-1">
                    <button onclick="openEditModal()" class="text-white p-2 btn-active" title="編輯名稱">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                     <button onclick="deleteCurrentProduct()" class="text-white p-2 btn-active" title="刪除商品">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </header>

            <!-- Stats Area (Now showing Min Price per Unit) -->
            <div class="bg-white p-4 shadow-sm mb-2 z-10 sticky top-[64px] flex justify-between items-end">
                <div>
                    <p class="text-xs text-gray-500 mb-1 font-bold text-teal-600">
                        <i class="fa-solid fa-crown text-yellow-400 mr-1"></i>歷史最低對比價 (每單位)
                    </p>
                    <div class="flex items-end gap-2">
                        <span class="text-3xl font-bold text-teal-600" id="detail-min-price">--</span>
                        <span class="text-sm text-gray-400 mb-1" id="detail-min-unit">元 / 單位</span>
                    </div>
                </div>
                <button onclick="analyzePriceHistory()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-indigo-200 transition-colors btn-active">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 智能分析
                </button>
            </div>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="price-history-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Price -->
            <button onclick="openModal('modal-add-price')" class="absolute bottom-6 right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- MODAL: Add Product, Edit Product (Same as before) -->
        
        <!-- MODAL: Add Product -->
        <div id="modal-add-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">新增商品</h2>
                <input type="text" id="input-product-name" placeholder="例如：雞蛋、衛生紙、iPhone 15..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="addProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">新增</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Edit Product Name -->
        <div id="modal-edit-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">修改商品名稱</h2>
                <input type="text" id="input-edit-product-name" placeholder="輸入新的名稱..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="saveEditProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">儲存</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Add Price (Unit Price Comparison Focused) - UPDATED -->
        <div id="modal-add-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">記一筆價格 (統一對比)</h2>
                    <p class="text-sm text-orange-600 font-medium">重量: /g, 物品: /件</p>
                </div>
                
                <!-- 總價與單位輸入 -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">原始價格數值 (總價)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-raw-price" placeholder="例如: 99.9 或 25000 (總價)" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                        <select id="input-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-orange-500" onchange="toggleQuantityInput(this.value)">
                            <option value="" disabled selected>請選單位</option>
                            <option value="per_item">元 / 件 (每件/每包裝)</option>
                            <option value="per_g">元 / g (每克)</option>
                            <option value="per_100g">元 / 100g (每百克)</option>
                            <option value="per_kg">元 / kg (每公斤)</option>
                            <option value="per_lb">元 / lb (每磅)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="add-error-message"></p>
                </div>

                <!-- 組合數量輸入 (針對 "元 / 件" 類型顯示) -->
                <div id="quantity-group" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-orange-500"></i> 數量 (包裝內實際件數)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-price-quantity" placeholder="例如: 3 (若為 $100/3 件)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">地點 (選填)</label>
                    <input type="text" id="input-price-location" placeholder="例如: 全聯/Costco" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">備註 (選填)</label>
                    <input type="text" id="input-price-note" placeholder="例如：會員特價/促銷活動..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="addPrice()" class="px-6 py-2 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 shadow-md btn-active transition-colors">計算並儲存</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Edit Price - UPDATED -->
        <div id="modal-edit-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-800">編輯價格紀錄</h2>
                
                <!-- 價格與單位輸入 (編輯模式) -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">原始價格數值 (總價)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-edit-raw-price" placeholder="0" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                        <select id="input-edit-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-teal-500" onchange="toggleQuantityInputEdit(this.value)">
                            <option value="per_item">元 / 件 (每件/每包裝)</option>
                            <option value="per_g">元 / g (每克)</option>
                            <option value="per_100g">元 / 100g (每百克)</option>
                            <option value="per_kg">元 / kg (每公斤)</option>
                            <option value="per_lb">元 / lb (每磅)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="edit-error-message"></p>
                </div>

                 <!-- 組合數量輸入 (編輯模式) -->
                <div id="quantity-group-edit" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-teal-500"></i> 數量 (包裝內實際件數)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-edit-price-quantity" placeholder="例如: 3 (若為 $100/3 件)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">地點 (選填)</label>
                    <input type="text" id="input-edit-price-location" placeholder="例如: 全聯" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">備註 (選填)</label>
                    <input type="text" id="input-edit-price-note" placeholder="例如：會員特價..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                    <button onclick="saveEditPrice()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">儲存修改</button>
                </div>
            </div>
        </div>

        <!-- MODAL: AI Analysis (Same as before) -->
        <div id="modal-ai-result" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI 分析報告
                    </h2>
                    <button onclick="closeModal('modal-ai-result')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div id="ai-result-content" class="prose text-sm">
                    <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                        <div class="loader mb-3"></div>
                        <p>Gemini 正在分析數據中...</p>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeModal('modal-ai-result')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm">關閉</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // 設定 API Key 以啟用 AI 功能
        const apiKey = ""; 
        const LB_TO_G = 453.592; // 1 磅約等於 453.592 克

        // --- State Management ---
        let products = [];
        let currentProductId = null;
        let currentSearchTerm = '';
        let editingPriceDate = null; 

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderProductList();
        });

        /**
         * 顯示/隱藏組合數量輸入框，僅在選擇 '元 / 件' 時顯示。
         * @param {string} unit - 原始單位。
         * @param {string} mode - 'add' or 'edit'.
         */
        function toggleQuantityInput(unit, mode = 'add') {
            const quantityGroupEl = document.getElementById(mode === 'add' ? 'quantity-group' : 'quantity-group-edit');
            if (unit === 'per_item') {
                quantityGroupEl.style.display = 'block';
            } else {
                quantityGroupEl.style.display = 'none';
                // Reset quantity to 1 when switching to a weight unit
                document.getElementById(mode === 'add' ? 'input-price-quantity' : 'input-edit-price-quantity').value = 1;
            }
        }
        function toggleQuantityInputEdit(unit) {
            toggleQuantityInput(unit, 'edit');
        }

        // --- Core Price Conversion Logic (UPDATED to accept quantity) ---

        /**
         * 核心換算函數：將任意單位價格換算為標準單位價格 (Price/g 或 Price/item)。
         * @param {number} price - 原始價格數值 (總價/包裝價)。
         * @param {string} unit - 原始單位 ('per_g', 'per_100g', 'per_kg', 'per_lb', 'per_item')。
         * @param {number} quantity - 數量 (若為 per_item 類型則使用，否則為 1)。
         * @returns {{standardPrice: number, standardUnitLabel: string}} 換算後的價格和標籤。
         */
        function calculateStandardPrice(price, unit, quantity = 1) {
            if (isNaN(price) || price <= 0) return { standardPrice: 0, standardUnitLabel: 'N/A' };
            if (unit === 'per_item' && (isNaN(quantity) || quantity <= 0)) {
                quantity = 1; // 確保數量至少為 1
            }

            let standardPrice = 0;
            let standardUnitLabel = 'N/A';

            switch (unit) {
                case 'per_item':
                    // 手機等非重量商品，標準價格 = 總價 / 數量
                    standardPrice = price / quantity;
                    standardUnitLabel = '件';
                    break;
                case 'per_g':
                    // 每克價格
                    standardPrice = price;
                    standardUnitLabel = 'g';
                    break;
                case 'per_100g':
                    // 每百克價格 / 100
                    standardPrice = price / 100;
                    standardUnitLabel = 'g';
                    break;
                case 'per_kg':
                    // 每公斤價格 / 1000
                    standardPrice = price / 1000;
                    standardUnitLabel = 'g';
                    break;
                case 'per_lb':
                    // 每磅價格 / 453.592 克
                    standardPrice = price / LB_TO_G;
                    standardUnitLabel = 'g';
                    break;
                default:
                    return { standardPrice: 0, standardUnitLabel: 'N/A' };
            }
            
            // 重量單位取小數點後四位，物件單位取兩位。
            const precision = standardUnitLabel === 'g' ? 4 : 2;
            return { 
                standardPrice: parseFloat(standardPrice.toFixed(precision)), 
                standardUnitLabel: standardUnitLabel 
            };
        }


        // --- Data Logic (using localStorage for simplicity) ---
        function saveData() {
            localStorage.setItem('priceTrackerUnitComparisonData_v3', JSON.stringify(products));
        }

        function loadData() {
            // Load from v3 key (new key to reflect the major update)
            const data = localStorage.getItem('priceTrackerUnitComparisonData_v3');
            if (data) {
                products = JSON.parse(data);
            } else {
                // 初始化範例數據
                products = [
                    {
                        id: Date.now(),
                        name: "範例：頂級咖啡豆",
                        prices: [
                            // 原始: 每公斤 $800 -> 換算: 每克 $0.8000
                            { rawPrice: 800, rawUnit: "per_kg", rawQuantity: 1, standardPrice: 0.8000, standardUnitLabel: 'g', date: new Date(Date.now() - 86400000 * 10).toISOString(), note: "原價", location: "好事多" },
                            // 原始: 每磅 $300 -> 換算: 每克 $0.6614
                            { rawPrice: 300, rawUnit: "per_lb", rawQuantity: 1, standardPrice: 0.6614, standardUnitLabel: 'g', date: new Date().toISOString(), note: "特價", location: "家樂福" }
                        ]
                    },
                    {
                        id: Date.now() + 1,
                        name: "範例：罐裝可樂 (3件促銷)",
                        prices: [
                            // 原始: $100 買 3 件 -> 換算: 每件 $33.33
                            { rawPrice: 100, rawUnit: "per_item", rawQuantity: 3, standardPrice: 33.33, standardUnitLabel: '件', date: new Date().toISOString(), note: "便利店 3 件 $100", location: "7-11" },
                            // 原始: $35 買 1 件 -> 換算: 每件 $35.00
                            { rawPrice: 35, rawUnit: "per_item", rawQuantity: 1, standardPrice: 35.00, standardUnitLabel: '件', date: new Date(Date.now() - 86400000 * 5).toISOString(), note: "單件價", location: "OK Mart" },
                        ]
                    }
                ];
                saveData();
            }
        }


        // --- Navigation / Modal Logic (Same as before, simplified) ---
        function goDetail(id) {
            currentProductId = id;
            renderProductDetail();
            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
        }

        function goHome() {
            currentProductId = null;
            renderProductList();
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('page-home').classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
            
            if (modalId === 'modal-add-price') {
                document.getElementById('input-raw-price').value = '';
                document.getElementById('input-price-unit').value = ''; 
                document.getElementById('input-price-quantity').value = 1; // Reset quantity
                document.getElementById('input-price-note').value = '';
                document.getElementById('input-price-location').value = '';
                document.getElementById('add-error-message').textContent = '';
                document.getElementById('quantity-group').style.display = 'none'; // Hide by default
                setTimeout(() => document.getElementById('input-raw-price').focus(), 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function handleSearch(value) {
            currentSearchTerm = value.trim().toLowerCase();
            renderProductList();
        }

        function addProduct() {
            const name = document.getElementById('input-product-name').value.trim();
            if (!name) return;

            products.unshift({ id: Date.now(), name: name, prices: [] }); 
            saveData();
            renderProductList();
            closeModal('modal-add-product');
        }
        
        function deleteCurrentProduct() {
            // Using a custom modal is better than confirm() but for brevity, we stick to confirm() here.
            if(confirm("確定要刪除這個商品嗎？")) { 
                products = products.filter(p => p.id !== currentProductId);
                saveData();
                goHome();
            }
        }

        function openEditModal() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;
            document.getElementById('input-edit-product-name').value = product.name;
            openModal('modal-edit-product');
        }

        function saveEditProduct() {
            const newName = document.getElementById('input-edit-product-name').value.trim();
            if (!newName) return;

            const product = products.find(p => p.id === currentProductId);
            if (product) {
                product.name = newName;
                saveData();
                document.getElementById('detail-title').textContent = newName;
                closeModal('modal-edit-product');
            }
        }
        
        // --- Price Entry Management (UPDATED to handle quantity) ---

        function addPrice() {
            const rawPrice = parseFloat(document.getElementById('input-raw-price').value);
            const rawUnit = document.getElementById('input-price-unit').value;
            let rawQuantity = parseFloat(document.getElementById('input-price-quantity').value); // Read quantity
            const note = document.getElementById('input-price-note').value.trim();
            const location = document.getElementById('input-price-location').value.trim();
            const errorMsgEl = document.getElementById('add-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(rawPrice) || rawPrice <= 0) { 
                errorMsgEl.textContent = "請輸入有效的價格數值 (總價)"; 
                return; 
            }
            if (!rawUnit) {
                errorMsgEl.textContent = "請選擇原始價格單位"; 
                return; 
            }

            // Check quantity only if unit is 'per_item'
            if (rawUnit === 'per_item') {
                if (isNaN(rawQuantity) || rawQuantity <= 0) {
                     errorMsgEl.textContent = "請輸入有效的數量 (件數)"; 
                    return; 
                }
            } else {
                rawQuantity = 1; // Force 1 for weight units
            }
            
            // 核心換算！取得標準化的價格和單位標籤 (傳入數量)
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(rawPrice, rawUnit, rawQuantity);

            const product = products.find(p => p.id === currentProductId);
            if (product) {
                product.prices.unshift({ 
                    rawPrice, 
                    rawUnit,
                    rawQuantity,            // 儲存原始數量
                    standardPrice,          // 儲存標準化的價格
                    standardUnitLabel,      // 儲存標準化的單位 (g 或 件)
                    date: new Date().toISOString(), 
                    note, 
                    location, 
                });
                saveData();
                renderProductDetail(); 
                closeModal('modal-add-price');
            }
        }

        function deletePrice(priceDate) {
            // Using a custom modal is better than confirm() but for brevity, we stick to confirm() here.
            if(!confirm("確定要刪除這筆價格紀錄嗎？\n (日期: " + new Date(priceDate).toLocaleString() + ")")) return;
            
            const product = products.find(p => p.id === currentProductId);
            if (product) {
                product.prices = product.prices.filter(p => p.date !== priceDate);
                saveData();
                renderProductDetail();
            }
        }

        function openEditPriceModal(priceDate) {
            const product = products.find(p => p.id === currentProductId);
            const entry = product ? product.prices.find(p => p.date === priceDate) : null;

            if (!entry) return;
            editingPriceDate = priceDate;

            // 填充 Modal 欄位
            document.getElementById('input-edit-raw-price').value = entry.rawPrice;
            document.getElementById('input-edit-price-unit').value = entry.rawUnit;
            document.getElementById('input-edit-price-note').value = entry.note;
            document.getElementById('input-edit-price-location').value = entry.location;
            document.getElementById('edit-error-message').textContent = '';
            
            // 填充數量欄位 (使用 ?? 確保舊資料也能正確顯示 1)
            document.getElementById('input-edit-price-quantity').value = entry.rawQuantity ?? 1;
            
            // 根據單位顯示/隱藏數量欄位
            toggleQuantityInputEdit(entry.rawUnit);

            openModal('modal-edit-price');
        }

        function saveEditPrice() {
            if (!editingPriceDate) return;

            const newRawPrice = parseFloat(document.getElementById('input-edit-raw-price').value);
            const newRawUnit = document.getElementById('input-edit-price-unit').value;
            let newRawQuantity = parseFloat(document.getElementById('input-edit-price-quantity').value); // Read quantity
            const newNote = document.getElementById('input-edit-price-note').value.trim();
            const newLocation = document.getElementById('input-edit-price-location').value.trim();
            const errorMsgEl = document.getElementById('edit-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(newRawPrice) || newRawPrice <= 0) { 
                errorMsgEl.textContent = "請輸入有效的價格數值 (總價)"; 
                return; 
            }

            // Check quantity only if unit is 'per_item'
            if (newRawUnit === 'per_item') {
                if (isNaN(newRawQuantity) || newRawQuantity <= 0) {
                     errorMsgEl.textContent = "請輸入有效的數量 (件數)"; 
                    return; 
                }
            } else {
                newRawQuantity = 1; // Force 1 for weight units
            }
            
            // 核心換算！更新標準化的價格和單位 (傳入數量)
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(newRawPrice, newRawUnit, newRawQuantity);


            const product = products.find(p => p.id === currentProductId);
            if (product) {
                const entry = product.prices.find(p => p.date === editingPriceDate);
                if (entry) {
                    // 更新欄位
                    entry.rawPrice = newRawPrice;
                    entry.rawUnit = newRawUnit;
                    entry.rawQuantity = newRawQuantity; // 更新原始數量
                    entry.note = newNote;
                    entry.location = newLocation;
                    entry.standardPrice = standardPrice; // 更新標準化價格
                    entry.standardUnitLabel = standardUnitLabel; // 更新標準化單位
                    
                    saveData();
                    renderProductDetail();
                    closeModal('modal-edit-price');
                    editingPriceDate = null;
                }
            }
        }


        // --- Render UI (UPDATED to show quantity) ---
        function renderProductList() {
            const container = document.getElementById('product-list-container');
            const filtered = products.filter(p => p.name.toLowerCase().includes(currentSearchTerm));
            filtered.sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><p>找不到商品</p><p class="text-sm">點擊右下角新增</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(product => {
                // 找出歷史最低對比價 (Price per Unit)
                const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;
                
                let priceDisplay = `<span class="text-gray-400 text-sm">無價格</span>`;

                if (minEntry) {
                    const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                    const unitText = minEntry.standardUnitLabel === 'g' ? '克' : '件';
                    
                    priceDisplay = `
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-gray-400">最低/ ${unitText}</span>
                            <span class="text-teal-600 font-bold text-lg">$${priceFormatted}</span>
                        </div>`; 
                }

                return `
                <div onclick="goDetail(${product.id})" class="bg-white p-4 rounded-xl shadow-sm mb-3 flex justify-between items-center btn-active cursor-pointer border-l-4 border-teal-500">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${product.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">紀錄: ${product.prices.length} 筆</p>
                    </div>
                    <div class="flex items-center">${priceDisplay}<i class="fa-solid fa-chevron-right text-gray-300 ml-3"></i></div>
                </div>`;
            }).join('');
        }

        function getUnitLabel(unit) {
             switch (unit) {
                case 'per_item': return '元 / 件 (每件/包裝)';
                case 'per_g': return '元 / g (每克)';
                case 'per_100g': return '元 / 100g (每百克)';
                case 'per_kg': return '元 / kg (每公斤)';
                case 'per_lb': return '元 / lb (每磅)';
                default: return '未知單位';
            }
        }

        function renderProductDetail() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;

            document.getElementById('detail-title').textContent = product.name;
            const minPriceEl = document.getElementById('detail-min-price');
            const minUnitEl = document.getElementById('detail-min-unit');
            
            // 找到歷史最低標準對比價及其單位
            const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;

            if (minEntry) {
                // 根據單位調整顯示精度
                const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                minPriceEl.textContent = priceFormatted;
                minUnitEl.textContent = `元 / ${minEntry.standardUnitLabel}`;
            } else {
                minPriceEl.textContent = '--';
                minUnitEl.textContent = '元 / 單位';
            }


            const container = document.getElementById('price-history-container');
            // 將價格紀錄按日期排序（最新在前）
            product.prices.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (product.prices.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><p>尚無紀錄</p></div>`;
                return;
            }

            container.innerHTML = product.prices.map((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
                
                let diffHtml = '';
                let diffPrecision = entry.standardUnitLabel === 'g' ? 4 : 2; // 差異也用對應的精度
                
                // 比較與前一筆紀錄的標準價格差異 (最新 vs 前一筆)
                if (index < product.prices.length - 1) {
                    // 確保只比較相同單位類型 (g vs g, 件 vs 件) 的價格
                    const prevEntry = product.prices[index + 1];
                    if (entry.standardUnitLabel === prevEntry.standardUnitLabel) {
                        const diff = entry.standardPrice - prevEntry.standardPrice;
                        if (diff > 0) diffHtml = `<span class="text-red-500 text-xs ml-2">▲ ${diff.toFixed(diffPrecision)}</span>`;
                        else if (diff < 0) diffHtml = `<span class="text-green-500 text-xs ml-2">▼ ${Math.abs(diff).toFixed(diffPrecision)}</span>`;
                    }
                }

                const unitLabel = getUnitLabel(entry.rawUnit);
                
                // 根據單位調整顯示精度
                const priceFormatted = entry.standardUnitLabel === 'g' ? entry.standardPrice.toFixed(4) : entry.standardPrice.toFixed(2);
                const standardUnitText = entry.standardUnitLabel === 'g' ? `g (每克對比價)` : `件 (每件對比價)`;

                // 顯示原始價格和數量
                const quantityText = entry.rawUnit === 'per_item' && entry.rawQuantity > 1 
                                     ? ` (共 ${entry.rawQuantity} 件)` 
                                     : '';
                
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-2 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <!-- 顯示統一的標準化價格 (最重要) -->
                            <span class="text-xl font-bold text-teal-600">$${priceFormatted}</span>
                            <span class="text-sm font-medium text-teal-500 ml-1">/ ${standardUnitText}</span>
                            ${diffHtml}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">原始輸入: 總價 $${entry.rawPrice} (${unitLabel})${quantityText}</p>
                        
                        ${entry.location ? `<p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-location-dot mr-1 text-teal-500"></i>${entry.location}</p>` : ''}
                        ${entry.note ? `<p class="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">${entry.note}</p>` : ''}
                    </div>
                    <div class="text-right whitespace-nowrap ml-2 flex flex-col items-end">
                        <p class="text-xs text-gray-400">${dateStr}</p>
                        <div class="mt-2 flex gap-2">
                             <button onclick="openEditPriceModal('${entry.date}')" class="text-teal-500 hover:text-teal-700 text-sm p-1 btn-active" title="編輯紀錄"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button onclick="deletePrice('${entry.date}')" class="text-red-400 hover:text-red-600 text-sm p-1 btn-active" title="刪除紀錄"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- AI Analysis (Simplified) ---
        async function analyzePriceHistory() {
            const product = products.find(p => p.id === currentProductId);
            if (!product || product.prices.length === 0) {
                // Using a custom modal is better than console.warn() but for brevity, we stick to console.warn() here.
                console.warn("請先新增一些價格紀錄，AI 才能進行分析喔！"); 
                return;
            }

            openModal('modal-ai-result');
            const container = document.getElementById('ai-result-content');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                    <div class="loader mb-3"></div>
                    <p>Gemini 正在分析 ${product.name} 的價格走勢...</p>
                </div>`;

            // 傳遞標準化價格數據給 AI
            const historyData = product.prices.slice(0, 10).map(p => ({
                date: new Date(p.date).toLocaleDateString(),
                standardPrice: p.standardPrice, 
                unit: p.standardUnitLabel,
                location: p.location,
                rawQuantity: p.rawQuantity, // Pass quantity for context
            }));
            
            // 判斷是重量商品還是物品
            const unitType = product.prices[0].standardUnitLabel === 'g' ? '重量型商品 (每克價格)' : '物品型商品 (每件價格)';

            // Note: Since API key is empty, the call will fail, but the structure is correct.
            const prompt = `
            請擔任購物專家。分析商品 "${product.name}" 的歷史價格。該商品屬於 ${unitType}。
            歷史價格紀錄（依日期排序）：${JSON.stringify(historyData)}
            用繁體中文回答：
            1. 價格評估 (現在的標準化價格是貴還是便宜?)
            2. 走勢分析 (標準化價格的變化趨勢?)
            3. 購買建議 (根據每單位價格推薦最低價的購買時機)
            `;
            
            const analysis = await callGeminiAPI(prompt); 

            if (analysis) {
                container.innerHTML = marked.parse(analysis);
            } else {
                container.innerHTML = `<p class="text-red-500 text-center">AI 分析失敗，請檢查 API Key 或稍後再試。</p>`;
            }
        }
        // Simplified callGeminiAPI placeholder
        async function callGeminiAPI(prompt) { return null; /* Mock */ } 
    </script>
</body>
</html>
