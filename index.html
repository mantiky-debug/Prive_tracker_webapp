<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒ¹æ ¼è¿½è¹¤å°å¹«æ‰‹</title>
    <!-- PWA Optimization Meta Tags for Mobile Experience -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked for Markdown rendering in AI analysis -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* General styling and PWA feel */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none; 
        }
        /* Hide scrollbar for cleaner mobile look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Page transition setup for single-page application feel */
        .page {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: none;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        /* Custom active state for buttons */
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        /* Loading spinner for API calls */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Basic Markdown styling for AI content */
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-bottom: 0.5rem; color: #111827; }
        .prose p { margin-bottom: 0.5rem; line-height: 1.6; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .prose strong { color: #0d9488; font-weight: 700; }
    </style>
</head>
<body>

    <!-- Main container, simulating a mobile device screen -->
    <div class="relative w-full h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden">
        
        <!-- Home Page: Product List -->
        <div id="page-home" class="page active">
            <header class="bg-teal-600 text-white p-4 shadow-md z-20 sticky top-0">
                <div class="flex justify-between items-center mb-3">
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-tag"></i> åƒ¹æ ¼è¿½è¹¤å°å¹«æ‰‹
                    </h1>
                </div>
                <!-- Search Input -->
                <div class="relative mb-3">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="æœå°‹å•†å“åç¨±..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-300 shadow-inner"
                        oninput="handleSearch(this.value)">
                </div>
                <!-- Sort Dropdown -->
                <div class="flex items-center justify-end text-sm">
                    <label for="sort-select" class="mr-2 text-gray-200 font-medium">æ’åº:</label>
                    <select id="sort-select" onchange="handleSort(this.value)" class="bg-teal-700 text-white rounded-lg p-1.5 focus:outline-none focus:ring-1 focus:ring-teal-300 border border-teal-500">
                        <option value="recent">ğŸ“ æœ€è¿‘æ–°å¢</option>
                    </select>
                </div>
            </header>

            <!-- Product List Content -->
            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="product-list-container">
                <!-- Content generated by renderProductList() -->
            </main>

            <!-- Add Product Button -->
            <button onclick="openModal('modal-add-product')" class="absolute bottom-6 right-6 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-teal-700 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- Detail Page: Price History -->
        <div id="page-detail" class="page">
            <header class="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3 z-20 sticky top-0">
                <!-- Back Button -->
                <button onclick="goHome()" class="text-white p-2 -ml-2 btn-active">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold truncate flex-1" id="detail-title">å•†å“åç¨±</h1>
                <div class="flex gap-1">
                    <!-- Edit Button -->
                    <button onclick="openEditModal()" class="text-white p-2 btn-active" title="ç·¨è¼¯å•†å“åç¨±">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <!-- Delete Button -->
                     <button onclick="deleteCurrentProduct()" class="text-white p-2 btn-active" title="åˆªé™¤å•†å“">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </header>

            <!-- Price Summary and AI Analysis Button -->
            <div class="bg-white p-4 shadow-sm mb-2 z-10 sticky top-[64px] flex justify-between items-end">
                <div>
                    <p class="text-xs text-gray-500 mb-1 font-bold text-teal-600">
                        <i class="fa-solid fa-crown text-yellow-400 mr-1"></i>æ­·å²æœ€ä½åƒ¹
                    </p>
                    <div class="flex items-end gap-2">
                        <span class="text-3xl font-bold text-teal-600" id="detail-min-price">--</span>
                        <span class="text-sm text-gray-400 mb-1">å…ƒ</span>
                    </div>
                </div>
                <button onclick="analyzePriceHistory()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-indigo-200 transition-colors btn-active">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½åˆ†æ
                </button>
            </div>

            <!-- Price History List -->
            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="price-history-container">
                <!-- Content generated by renderProductDetail() -->
            </main>

            <!-- Add Price Button -->
            <button onclick="openModal('modal-add-price')" class="absolute bottom-6 right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
        </div>

        <!-- MODALS (Dialogs) -->

        <!-- Modal 1: Add New Product -->
        <div id="modal-add-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢å•†å“</h2>
                <input type="text" id="input-product-name" placeholder="ä¾‹å¦‚ï¼šé›è›‹ã€è¡›ç”Ÿç´™..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="addProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">æ–°å¢</button>
                </div>
            </div>
        </div>

        <!-- Modal 2: Edit Product Name -->
        <div id="modal-edit-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ä¿®æ”¹å•†å“åç¨±</h2>
                <input type="text" id="input-edit-product-name" placeholder="è¼¸å…¥æ–°çš„åç¨±..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveEditProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- Modal 3: Add New Price Entry (Includes Smart Input) -->
        <div id="modal-add-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">è¨˜ä¸€ç­†åƒ¹æ ¼</h2>
                    <button onclick="toggleSmartInput()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition-colors">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½è¼¸å…¥
                    </button>
                </div>

                <!-- Smart Input Section (uses Gemini API for parsing) -->
                <div id="smart-input-section" class="hidden mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <label class="block text-xs text-indigo-600 mb-1 font-medium">ç”¨ä¸€å¥è©±æè¿° (AI è‡ªå‹•å¡«å¯«)</label>
                    <textarea id="smart-input-text" rows="2" placeholder="ä¾‹å¦‚ï¼šæ˜¨å¤©åœ¨å…¨è¯è²·äº†ä¸€ç›’é›è›‹ 65 å…ƒ..." class="w-full text-sm border border-indigo-200 rounded p-2 mb-2 focus:outline-none focus:border-indigo-400"></textarea>
                    <div class="flex justify-end">
                         <button onclick="parseSmartInput()" id="btn-smart-parse" class="bg-indigo-600 text-white text-xs px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center gap-1">
                            <span>è§£æ</span> <i class="fa-solid fa-bolt"></i>
                         </button>
                    </div>
                </div>
                
                <!-- Manual Input Fields -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">åƒ¹æ ¼ (å…ƒ)</label>
                    <input type="number" id="input-price-value" placeholder="0" class="w-full border border-gray-300 rounded-lg p-3 text-xl font-bold focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">åœ°é» (é¸å¡«)</label>
                        <input type="text" id="input-price-location" placeholder="ä¾‹å¦‚: å…¨è¯" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">é‡é‡/è¦æ ¼ (é¸å¡«)</label>
                        <input type="text" id="input-price-weight" placeholder="ä¾‹å¦‚: 100g" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="input-price-note" placeholder="ä¾‹å¦‚ï¼šæœƒå“¡ç‰¹åƒ¹..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="addPrice()" class="px-6 py-2 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 shadow-md btn-active transition-colors">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- Modal 4: AI Analysis Result -->
        <div id="modal-ai-result" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI åˆ†æå ±å‘Š
                    </h2>
                    <button onclick="closeModal('modal-ai-result')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div id="ai-result-content" class="prose text-sm">
                    <!-- Loading or Analysis Content -->
                    <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                        <div class="loader mb-3"></div>
                        <p>Gemini æ­£åœ¨åˆ†ææ•¸æ“šä¸­...</p>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeModal('modal-ai-result')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm">é—œé–‰</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // NOTE: The API key is required for AI features (Smart Input & Price Analysis)
        const apiKey = ""; 

        let products = []; // Array to hold product objects
        let currentProductId = null; // ID of the product currently viewed
        let currentSearchTerm = '';
        let currentSort = 'recent'; 

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('sort-select').value = currentSort;
            renderProductList();
        });

        // --- GEMINI API FUNCTIONS ---

        /**
         * Generic function to call the Gemini API.
         * @param {string} prompt - The text prompt for the model.
         * @returns {Promise<string|null>} The generated text result or null on failure.
         */
        async function callGeminiAPI(prompt) {
            // Check for API Key
            if (!apiKey) {
                console.error("API Key not set.");
                window.alert("è«‹å…ˆè¨­å®š API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼"); 
                return null;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    // Handle rate limiting with exponential backoff
                    if (response.status === 429 && i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    // On final failure, return null
                    if (i === MAX_RETRIES - 1) return null;
                    
                    // Delay before retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            return null;
        }

        /**
         * Toggles the Smart Input UI section.
         */
        function toggleSmartInput() {
            const section = document.getElementById('smart-input-section');
            section.classList.toggle('hidden');
        }

        /**
         * Uses Gemini to parse natural language text into structured price data (JSON).
         */
        async function parseSmartInput() {
            const text = document.getElementById('smart-input-text').value;
            if (!text.trim()) return;

            const btn = document.getElementById('btn-smart-parse');
            const originalHtml = btn.innerHTML;
            // Show loading state
            btn.innerHTML = `<div class="loader" style="width:12px;height:12px;border-width:2px;"></div> è§£æä¸­...`;
            btn.disabled = true;

            const prompt = `
            ä½ æ˜¯ä¸€å€‹å¹«åŠ©è¨˜éŒ„è³¼ç‰©åƒ¹æ ¼çš„åŠ©æ‰‹ã€‚è«‹å¾ä»¥ä¸‹æ–‡å­—ä¸­æå–ï¼š
            1. price (æ•¸å­—, è‹¥ç„¡å‰‡ç‚º null)
            2. location (å•†åº—åç¨±, å­—ä¸², è‹¥ç„¡å‰‡ç‚º "")
            3. weight (é‡é‡æˆ–æ•¸é‡è¦æ ¼, å­—ä¸², è‹¥ç„¡å‰‡ç‚º "")
            4. note (å…¶ä»–å‚™è¨»ç´°ç¯€, å­—ä¸², è‹¥ç„¡å‰‡ç‚º "")
            
            æ–‡å­—ï¼š "${text}"
            
            è«‹åªå›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜ã€‚ç¯„ä¾‹ï¼š{"price": 100, "location": "7-11", "weight": "1å€‹", "note": "å¥½åƒ"}
            `;

            const resultText = await callGeminiAPI(prompt);
            
            if (resultText) {
                try {
                    // Clean up potential markdown formatting from the response
                    const jsonStr = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(jsonStr);

                    // Populate form fields with parsed data
                    if (data.price !== null && !isNaN(parseFloat(data.price))) document.getElementById('input-price-value').value = parseFloat(data.price);
                    if (data.location) document.getElementById('input-price-location').value = data.location;
                    if (data.weight) document.getElementById('input-price-weight').value = data.weight;
                    if (data.note) document.getElementById('input-price-note').value = data.note;
                    
                    // Show success status
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-green-600');
                    btn.innerHTML = `<i class="fa-solid fa-check"></i> å®Œæˆ`;
                    setTimeout(() => {
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-indigo-600');
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                    }, 1500);

                } catch (e) {
                    console.error("JSON è§£æéŒ¯èª¤:", e);
                    window.alert("AI è§£æå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            } else {
                // Show failure status
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        /**
         * Uses Gemini to analyze the historical price data and provide a report.
         */
        async function analyzePriceHistory() {
            const product = products.find(p => p.id === currentProductId);
            if (!product || product.prices.length === 0) {
                window.alert("è«‹å…ˆæ–°å¢ä¸€äº›åƒ¹æ ¼ç´€éŒ„ï¼ŒAI æ‰èƒ½é€²è¡Œåˆ†æå–”ï¼");
                return;
            }

            openModal('modal-ai-result');
            const container = document.getElementById('ai-result-content');
            
            // Initial loading state
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                    <div class="loader mb-3"></div>
                    <p>Gemini æ­£åœ¨åˆ†æ ${product.name} çš„åƒ¹æ ¼èµ°å‹¢...</p>
                </div>`;

            // Prepare truncated price history data for the prompt
            const historyData = product.prices.slice(0, 10).map(p => ({
                date: p.date.split('T')[0],
                price: p.price,
                location: p.location,
                weight: p.weight
            }));

            const prompt = `
            è«‹æ“”ä»»ä¸€ä½ç²¾æ‰“ç´°ç®—çš„è³¼ç‰©å°ˆå®¶ã€‚
            å•†å“åç¨±ï¼š${product.name}
            æ­·å²åƒ¹æ ¼ç´€éŒ„ (JSON)ï¼š${JSON.stringify(historyData)}
            
            è«‹ç”¨ç¹é«”ä¸­æ–‡ (Traditional Chinese) åˆ†æä¸¦å›ç­”ä»¥ä¸‹å•é¡Œï¼š
            1. **åƒ¹æ ¼è©•ä¼°**ï¼šæœ€æ–°çš„ä¸€ç­†åƒ¹æ ¼æ¯”èµ·å¹³å‡æ°´æº–æ˜¯è²´é‚„æ˜¯ä¾¿å®œï¼Ÿ
            2. **èµ°å‹¢åˆ†æ**ï¼šè¿‘æœŸçš„åƒ¹æ ¼è¶¨å‹¢æ˜¯åœ¨ä¸Šæ¼²é‚„æ˜¯ä¸‹è·Œï¼Ÿ
            3. **è³¼è²·å»ºè­°**ï¼šç¾åœ¨é©åˆå›¤è²¨å—ï¼Ÿ
            4. **ä¿å­˜æˆ–é¸è³¼å°æ’‡æ­¥**ï¼šçµ¦å‡ºä¸€å€‹é—œæ–¼ "${product.name}" çš„å¯¦ç”¨é¸è³¼æˆ–ä¿å­˜å»ºè­°ã€‚

            è«‹ä½¿ç”¨ Markdown æ ¼å¼æ’ç‰ˆï¼Œèªæ°£è¦ªåˆ‡å°ˆæ¥­ï¼Œé‡é»æ¨™è¨»ã€‚
            `;

            const analysis = await callGeminiAPI(prompt);

            if (analysis) {
                // Render the Markdown output
                container.innerHTML = marked.parse(analysis);
            } else {
                container.innerHTML = `<p class="text-red-500 text-center">åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            }
        }

        // --- DATA MANAGEMENT (Using localStorage for persistence) ---

        function saveData() {
            localStorage.setItem('priceTrackerData', JSON.stringify(products));
        }

        function loadData() {
            const data = localStorage.getItem('priceTrackerData');
            if (data) {
                products = JSON.parse(data);
            } else {
                // Initialize with mock data if storage is empty
                products = [
                    {
                        id: Date.now() + 1,
                        name: "å¥½å–å’–å•¡è±†",
                        prices: [
                            { price: 450, date: new Date(Date.now() - 86400000 * 10).toISOString(), note: "åŸåƒ¹", location: "Costco", weight: "1kg" },
                            { price: 399, date: new Date(Date.now() - 86400000 * 5).toISOString(), note: "é›™11ç‰¹åƒ¹", location: "PChome", weight: "1kg" }
                        ]
                    },
                    {
                        id: Date.now(),
                        name: "æ²ç­’è¡›ç”Ÿç´™",
                        prices: [
                            { price: 299, date: new Date().toISOString(), note: "è³£å ´ä¿ƒéŠ·", location: "å®¶æ¨‚ç¦", weight: "12å…¥" }
                        ]
                    }
                ];
                saveData();
            }
        }

        // --- NAVIGATION & UI HELPERS ---

        function goDetail(id) {
            currentProductId = id;
            renderProductDetail();
            
            // Simple page transition
            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
        }

        function goHome() {
            currentProductId = null;
            renderProductList();
            
            // Simple page transition
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('page-home').classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
            
            // Optional: Focus input field on modal open
            if(modalId === 'modal-add-product') {
                setTimeout(() => document.getElementById('input-product-name').focus(), 100);
            } else if (modalId === 'modal-add-price') {
                document.getElementById('smart-input-section').classList.add('hidden');
                document.getElementById('smart-input-text').value = '';
                document.getElementById('input-price-value').value = '';
                document.getElementById('input-price-note').value = '';
                document.getElementById('input-price-location').value = '';
                document.getElementById('input-price-weight').value = '';
                setTimeout(() => document.getElementById('input-price-value').focus(), 100);
            } else if (modalId === 'modal-edit-product') {
                setTimeout(() => document.getElementById('input-edit-product-name').focus(), 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // --- PRODUCT ACTIONS ---

        function handleSearch(value) {
            currentSearchTerm = value.trim().toLowerCase();
            renderProductList();
        }

        function handleSort(sortKey) {
            currentSort = sortKey;
            renderProductList();
        }
        
        function addProduct() {
            const nameInput = document.getElementById('input-product-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                window.alert("å•†å“åç¨±ä¸èƒ½ç‚ºç©ºã€‚");
                return;
            }

            const newProduct = {
                id: Date.now(),
                name: name,
                prices: []
            };

            products.push(newProduct);
            saveData();
            renderProductList();
            closeModal('modal-add-product');
        }
        
        function deleteCurrentProduct() {
             // Using window.confirm temporarily, should be replaced with a custom modal in a real app
            if(window.confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“åŠå…¶æ‰€æœ‰åƒ¹æ ¼ç´€éŒ„å—ï¼Ÿ")) {
                products = products.filter(p => p.id !== currentProductId);
                saveData();
                goHome();
            }
        }

        function openEditModal() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;
            
            document.getElementById('input-edit-product-name').value = product.name;
            openModal('modal-edit-product');
        }

        function saveEditProduct() {
            const nameInput = document.getElementById('input-edit-product-name');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                window.alert("å•†å“åç¨±ä¸èƒ½ç‚ºç©ºã€‚");
                return;
            }

            const productIndex = products.findIndex(p => p.id === currentProductId);
            if (productIndex !== -1) {
                products[productIndex].name = newName;
                saveData();
                
                // Update detail page title immediately
                document.getElementById('detail-title').textContent = newName;
                
                closeModal('modal-edit-product');
            }
        }

        // --- PRICE ACTIONS ---

        function addPrice() {
            const priceInput = document.getElementById('input-price-value');
            const noteInput = document.getElementById('input-price-note');
            const locationInput = document.getElementById('input-price-location'); 
            const weightInput = document.getElementById('input-price-weight');    
            
            const price = parseFloat(priceInput.value);
            const note = noteInput.value.trim();
            const location = locationInput.value.trim(); 
            const weight = weightInput.value.trim();    

            if (isNaN(price) || price <= 0) {
                 window.alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼ï¼");
                 return;
            }

            const productIndex = products.findIndex(p => p.id === currentProductId);
            if (productIndex !== -1) {
                // Add new price entry to the beginning of the array (most recent first)
                products[productIndex].prices.unshift({ 
                    price: price,
                    date: new Date().toISOString(),
                    note: note,
                    location: location, 
                    weight: weight      
                });
                saveData();
                renderProductDetail(); 
                closeModal('modal-add-price');
            }
        }

        // --- RENDERING FUNCTIONS ---

        function renderProductList() {
            const container = document.getElementById('product-list-container');
            
            let displayProducts = products.filter(p => 
                p.name.toLowerCase().includes(currentSearchTerm)
            );
            
            // Always sort by ID (creation date) for "recent"
            displayProducts.sort((a, b) => b.id - a.id);

            // Ensure the dropdown reflects the current sort setting
            if (document.getElementById('sort-select').value !== currentSort) {
                document.getElementById('sort-select').value = currentSort;
            }


            if (products.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-20 animate-pulse">
                        <i class="fa-solid fa-basket-shopping text-6xl mb-4"></i>
                        <p>é‚„æ²’æœ‰å•†å“ç´€éŒ„</p>
                        <p class="text-sm">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢</p>
                    </div>`;
                return;
            }

            if (displayProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-20">
                        <i class="fa-solid fa-magnifying-glass text-6xl mb-4"></i>
                        <p>æ‰¾ä¸åˆ° "${currentSearchTerm}"</p>
                        <p class="text-sm">è©¦è©¦å…¶ä»–é—œéµå­—ï¼Ÿ</p>
                    </div>`;
                return;
            }

            let html = '';
            displayProducts.forEach(product => {
                const minPrice = product.prices.length > 0 
                    ? Math.min(...product.prices.map(p => p.price)) 
                    : null;

                const priceDisplay = minPrice 
                    ? `<div class="flex flex-col items-end">
                         <span class="text-xs text-gray-400 font-medium">æœ€ä½</span>
                         <span class="text-teal-600 font-bold text-lg">$${minPrice}</span>
                       </div>` 
                    : `<span class="text-gray-400 text-sm">å°šç„¡åƒ¹æ ¼</span>`;

                html += `
                <div onclick="goDetail(${product.id})" class="bg-white p-4 rounded-xl shadow-sm mb-3 flex justify-between items-center btn-active cursor-pointer border-l-4 border-teal-500 hover:shadow-md transition-shadow">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${product.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">ç´€éŒ„ç­†æ•¸: ${product.prices.length}</p>
                    </div>
                    <div class="flex items-center">
                        ${priceDisplay}
                        <i class="fa-solid fa-chevron-right text-gray-300 ml-3"></i>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderProductDetail() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;

            document.getElementById('detail-title').textContent = product.name;
            
            // Calculate and display historical minimum price
            const minPriceEl = document.getElementById('detail-min-price');
            if (product.prices.length > 0) {
                const minPrice = Math.min(...product.prices.map(p => p.price));
                minPriceEl.textContent = minPrice;
            } else {
                minPriceEl.textContent = '--';
            }

            const container = document.getElementById('price-history-container');
            
            const displayPrices = product.prices; 

            if (displayPrices.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><p>é»æ“Šå³ä¸‹è§’è¨˜ç¬¬ä¸€ç­†å¸³å§ï¼</p></div>`;
                return;
            }
            
            let html = '';
            
            displayPrices.forEach((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                
                // Price difference calculation against the *previous* entry
                let diffHtml = '';
                if (index < displayPrices.length - 1) {
                    const prevPrice = displayPrices[index + 1].price;
                    const diff = entry.price - prevPrice;
                    if (diff > 0) diffHtml = `<span class="text-red-500 text-xs ml-2">â–² ${diff}</span>`; // Price increase
                    else if (diff < 0) diffHtml = `<span class="text-green-500 text-xs ml-2">â–¼ ${Math.abs(diff)}</span>`; // Price decrease
                }


                // Location and Weight/Spec badges
                let metaInfoHtml = '';
                if (entry.location || entry.weight) {
                    metaInfoHtml = `<div class="flex gap-3 mt-1 text-xs text-gray-500">`;
                    if (entry.location) {
                        metaInfoHtml += `<span class="flex items-center"><i class="fa-solid fa-location-dot mr-1 text-teal-500"></i> ${entry.location}</span>`;
                    } 
                    if (entry.weight) {
                        metaInfoHtml += `<span class="flex items-center"><i class="fa-solid fa-scale-balanced mr-1 text-teal-500"></i> ${entry.weight}</span>`;
                    }
                    metaInfoHtml += `</div>`;
                }

                html += `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-2 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <span class="text-xl font-bold text-gray-800">$${entry.price}</span>
                            ${diffHtml}
                        </div>
                        ${metaInfoHtml}
                        ${entry.note ? `<p class="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">${entry.note}</p>` : ''}
                    </div>
                    <div class="text-right whitespace-nowrap ml-2">
                        <p class="text-xs text-gray-400">${dateStr}</p>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>