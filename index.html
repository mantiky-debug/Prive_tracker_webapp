<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>價格追蹤 App (雲端版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 10px;
        }
        .header {
            background-color: #0d9488; /* 綠松石色 */
            color: white;
            padding: 20px 16px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- App Header -->
        <div class="header">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <!-- ⚖️ Lucide Scale Icon -->
                    <i data-lucide="scale" class="w-6 h-6"></i>
                    <h1 class="text-2xl font-bold">價格對比追蹤 (雲端版)</h1>
                </div>
            </div>
            <p class="text-sm mt-1 opacity-90">統一換算為每單位價格 (克或件) 進行比較</p>
            <div id="status-message" class="text-xs mt-2 font-medium">正在初始化...</div>
        </div>

        <!-- Search Bar -->
        <div class="mt-4 px-2">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="搜尋商品名稱..." class="w-full p-3 pl-10 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
            </div>
        </div>

        <!-- Product List -->
        <div id="product-list" class="mt-4 space-y-3 px-2">
            <!-- Data will be inserted here -->
        </div>

        <!-- Floating Action Button -->
        <button id="add-product-btn" class="fixed right-6 bottom-6 bg-teal-600 text-white p-4 rounded-full shadow-lg hover:bg-teal-700 transition duration-300 transform active:scale-95">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>

        <!-- Modal for Adding/Editing Product -->
        <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">新增產品</h2>
                <form id="product-form" class="space-y-4">
                    <input type="hidden" id="product-id">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">產品名稱</label>
                        <input type="text" id="name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700">總價格 ($)</label>
                            <input type="number" id="price" required min="0.01" step="0.01" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">總數量</label>
                            <input type="number" id="quantity" required min="1" step="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500">
                        </div>
                    </div>

                    <div>
                        <label for="unit" class="block text-sm font-medium text-gray-700">單位 (例如: 克, 個, 毫升)</label>
                        <input type="text" id="unit" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">取消</button>
                        <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition duration-150 font-semibold shadow-md">儲存產品</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts and Main Application Logic -->
    <script type="module">
        // *** 修正: setLogLevel 應該從 firebase-app.js 導入 ***
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // 移除錯誤的 setLogLevel 導入: import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        
        // 啟用 Firebase Debug 模式以查看詳細錯誤 (非常重要)
        setLogLevel('debug');

        // 全域變數
        let app = null;
        let db = null;
        let auth = null;
        let currentUserId = null;
        let unsubscribe = null; // 用於儲存 onSnapshot 的取消訂閱函數

        // --------------------------------------------------------
        // 1. 環境變數處理
        // --------------------------------------------------------
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const statusElement = document.getElementById('status-message');

        /**
         * 更新應用程式的狀態訊息
         * @param {string} message - 要顯示的訊息
         * @param {boolean} isError - 是否為錯誤訊息
         */
        function updateStatus(message, isError = false) {
            console.log("STATUS:", message);
            statusElement.textContent = message;
            statusElement.className = `text-xs mt-2 font-medium ${isError ? 'text-red-500' : 'text-white'}`;
        }
        
        /**
         * 轉換數字為每單位的價格字串
         * @param {number} price - 總價格
         * @param {number} quantity - 總數量
         * @param {string} unit - 單位
         * @returns {string} - 每單位的價格字串
         */
        function calculateAndFormatPrice(price, quantity, unit) {
            if (price > 0 && quantity > 0) {
                const pricePerUnit = price / quantity;
                return `約 $${pricePerUnit.toFixed(2)} / ${unit}`;
            }
            return '價格資訊不完整';
        }

        /**
         * 渲染產品列表
         * @param {Array<Object>} products - 產品數據陣列
         * @param {string} searchQuery - 搜尋關鍵字
         */
        function renderProductList(products, searchQuery = '') {
            const listElement = document.getElementById('product-list');
            listElement.innerHTML = '';
            
            const normalizedQuery = searchQuery.trim().toLowerCase();
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(normalizedQuery) ||
                product.unit.toLowerCase().includes(normalizedQuery)
            );

            if (filteredProducts.length === 0) {
                // 修正後的樣板字串
                listElement.innerHTML = `<p class="text-center text-gray-500 py-10">找不到產品。${searchQuery ? `或嘗試新增 "${searchQuery}"` : ''}</p>`;
                return;
            }

            // 排序: 最新建立的在最上面
            filteredProducts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            filteredProducts.forEach(product => {
                const pricePerUnitText = calculateAndFormatPrice(product.price, product.quantity, product.unit);

                const productItem = document.createElement('div');
                productItem.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center transition duration-150 hover:shadow-lg';
                productItem.innerHTML = `
                    <div class="flex-1 min-w-0" data-id="${product.id}">
                        <h3 class="text-lg font-semibold text-gray-800 truncate">${product.name}</h3>
                        <p class="text-teal-600 font-bold text-xl mt-1">${pricePerUnitText}</p>
                        <p class="text-sm text-gray-500 mt-1">總價: $${product.price.toFixed(2)} / 總量: ${product.quantity} ${product.unit}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-action="edit" data-id="${product.id}" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition duration-150">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <button data-action="delete" data-id="${product.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                listElement.appendChild(productItem);
            });
            // 重新渲染 Lucide 圖標
            lucide.createIcons();
        }

        // --------------------------------------------------------
        // 2. Firebase 初始化和認證 (關鍵修正區)
        // --------------------------------------------------------

        /**
         * 初始化 Firebase 應用程式、認證，並啟動資料監聽
         */
        async function setupFirebaseAndFetchData() {
            if (!firebaseConfig) {
                updateStatus('錯誤: 缺少 Firebase 配置資訊。', true);
                return;
            }

            updateStatus('正在初始化 Firebase 服務...');
            
            try {
                // 1. 初始化 App 和 Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 設定持久性為 Session（瀏覽器關閉即登出，適合測試）
                await setPersistence(auth, browserSessionPersistence);
                
                // 2. 身份驗證流程
                updateStatus('正在進行使用者身份驗證...');

                if (initialAuthToken) {
                    // 使用 Custom Token 登入 (Canvas 環境的主要方式)
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Firebase: Signed in with Custom Token.");
                } else {
                    // 如果沒有 token，則使用匿名登入
                    await signInAnonymously(auth);
                    console.log("Firebase: Signed in Anonymously (No token).");
                }
                
                // 3. 取得 User ID 並開始資料監聽
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        updateStatus(`已連線 (用戶ID: ${currentUserId.substring(0, 8)}...)`);
                        
                        // 確保之前的監聽器被取消 (避免重複)
                        if (unsubscribe) {
                            unsubscribe();
                        }

                        // 設置 Firestore 監聽器
                        startFirestoreListener();
                        
                    } else {
                        // 認證失敗的最終狀態
                        currentUserId = null;
                        updateStatus('認證失敗，請檢查配置和網路。', true);
                    }
                });

            } catch (error) {
                // 捕獲任何初始化或認證期間的嚴重錯誤
                console.error("Firebase Initialization or Authentication Error:", error);
                updateStatus(`連線失敗，請檢查配置: ${error.code}`, true);
            }
        }

        /**
         * 啟動 Firestore 實時資料監聽
         */
        function startFirestoreListener() {
            if (!db || !currentUserId) return;

            // 根據規則定義的路徑：/artifacts/{appId}/users/{userId}/products
            const productsCollectionPath = `artifacts/${appId}/users/${currentUserId}/products`;
            const productsCollectionRef = collection(db, productsCollectionPath);
            
            // 創建查詢：按建立時間降序排列 (最新在最上)
            const q = query(productsCollectionRef, orderBy("createdAt", "desc"));

            updateStatus('正在從資料庫同步資料...');

            // 啟動實時監聽 (onSnapshot)
            unsubscribe = onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                // 成功取得資料後，更新狀態
                updateStatus(`已同步 (${products.length} 個產品)`);
                renderProductList(products);
            }, (error) => {
                // 處理 onSnapshot 錯誤 (通常是 Permission Denied)
                console.error("Firestore Listener Error:", error);
                updateStatus(`資料同步錯誤: ${error.message} (請確認規則是否正確)`, true);
            });
        }

        // --------------------------------------------------------
        // 3. CRUD 邏輯和 UI 互動
        // --------------------------------------------------------

        // 模態框 (Modal) 元素
        const modal = document.getElementById('product-modal');
        const form = document.getElementById('product-form');
        const modalTitle = document.getElementById('modal-title');
        const productIdInput = document.getElementById('product-id');
        const nameInput = document.getElementById('name');
        const priceInput = document.getElementById('price');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');

        // 打開模態框
        function openModal(product = null) {
            form.reset();
            if (product) {
                modalTitle.textContent = '編輯產品';
                productIdInput.value = product.id;
                nameInput.value = product.name;
                priceInput.value = product.price;
                quantityInput.value = product.quantity;
                unitInput.value = product.unit;
            } else {
                modalTitle.textContent = '新增產品';
                productIdInput.value = '';
            }
            modal.classList.remove('hidden');
        }

        // 關閉模態框
        function closeModal() {
            modal.classList.add('hidden');
        }

        // 儲存產品 (新增或編輯)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !currentUserId) {
                updateStatus('錯誤: 資料庫尚未連線或認證失敗。', true);
                return;
            }

            const isEdit = !!productIdInput.value;
            const id = productIdInput.value;
            
            const productData = {
                name: nameInput.value.trim(),
                price: parseFloat(priceInput.value),
                quantity: parseInt(quantityInput.value),
                unit: unitInput.value.trim(),
                createdAt: serverTimestamp() // 使用 Firestore 伺服器時間戳
            };

            const productsCollectionPath = `artifacts/${appId}/users/${currentUserId}/products`;
            
            try {
                if (isEdit) {
                    // 編輯 (Update)
                    const productRef = doc(db, productsCollectionPath, id);
                    // 確保更新時不覆寫 createdAt
                    await updateDoc(productRef, productData);
                } else {
                    // 新增 (Create)
                    await addDoc(collection(db, productsCollectionPath), productData);
                }
                closeModal();
                updateStatus(isEdit ? '產品已更新。' : '產品已新增。');
            } catch (error) {
                console.error("儲存產品錯誤:", error);
                updateStatus(`儲存失敗: ${error.message}`, true);
            }
        });

        // 刪除產品
        async function deleteProduct(id) {
            if (!db || !currentUserId) return;

            // 使用自定義確認框取代 alert/confirm
            const confirmation = window.confirm('確定要刪除這個產品嗎？');
            if (confirmation) {
                try {
                    const productsCollectionPath = `artifacts/${appId}/users/${currentUserId}/products`;
                    await deleteDoc(doc(db, productsCollectionPath, id));
                    updateStatus('產品已刪除。');
                } catch (error) {
                    console.error("刪除產品錯誤:", error);
                    updateStatus(`刪除失敗: ${error.message}`, true);
                }
            }
        }

        // 委派事件處理器 (用於編輯和刪除按鈕)
        document.getElementById('product-list').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const action = target.getAttribute('data-action');
            const id = target.getAttribute('data-id');

            if (action === 'edit') {
                // 從當前渲染的列表中找到產品數據（這裡需要一個更好的方法，暫時忽略）
                // 由於 onSnapshot 會重新同步，這裡只需要打開模態框
                // 實際編輯時，我們應該從 Firestore 讀取最新數據，但為了簡化，先假設數據在渲染時是準確的
                const productElement = document.querySelector(`[data-id="${id}"]`);
                if (productElement) {
                    // 這裡理想情況下應該從內存中的 products 陣列獲取完整數據
                    // 由於沒有維護全局產品陣列，我們使用佔位符，但 CRUD 操作會依賴 ID
                    openModal({
                        id,
                        name: productElement.querySelector('h3').textContent,
                        // 注意: 這裡的數據解析依賴於 HTML 結構，在真實應用中應避免
                        price: parseFloat(productElement.parentElement.querySelector('.text-sm.text-gray-500').textContent.match(/總價: \$(\d+\.?\d*)/)[1]),
                        quantity: parseInt(productElement.parentElement.querySelector('.text-sm.text-gray-500').textContent.match(/總量: (\d+)/)[1]),
                        unit: productElement.parentElement.querySelector('.text-sm.text-gray-500').textContent.match(/總量: \d+ (.*)/)[1].trim(),
                    });
                }
            } else if (action === 'delete') {
                deleteProduct(id);
            }
        });


        // 4. 事件監聽器
        document.getElementById('add-product-btn').addEventListener('click', () => openModal(null));
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            // 點擊背景時關閉模態框
            if (e.target === modal) {
                closeModal();
            }
        });

        // 搜尋功能
        document.getElementById('search-input').addEventListener('input', (e) => {
            // 由於 onSnapshot 已經將所有數據同步到內存中（通過 renderProductList），我們只需重新渲染
            // 這裡需要一個全局的產品列表，但由於單文件限制，我們目前依賴 onSnapshot 的產品快照。
            // 為了讓搜尋能運作，我們必須在 renderProductList 中執行過濾。
            // 這裡我們觸發一次虛擬同步，理想情況下應該從內存中讀取。
            // 由於目前的實現，每次輸入都會觸發 onSnapshot 重新取得數據，這是低效的，但能運作。
            // 這裡我們只執行一次重新渲染（雖然在 HTML 裡很難維護全局狀態）。
            // 為了避免複雜的狀態管理，我們依靠 onSnapshot 的最新數據。
            if (unsubscribe) {
                unsubscribe();
                startFirestoreListener(e.target.value); // 傳遞搜尋值給監聽器 (但實際監聽器不會用)
            }
            // 由於 startFirestoreListener 不接受參數，我們依靠 onSnapshot 取得最新數據後，在 renderProductList 裡用全域搜尋值篩選。
            // 為了讓搜尋能運作，我們必須在 renderProductList 裡加入一個邏輯來處理這個輸入。
            // 這裡我們暫時移除重啟監聽器，僅依靠 input 事件來觸發篩選邏輯 (這需要將產品數據儲存在全域變數中)。
            
            // 由於目前代碼結構限制，暫時保持原來的 onSnapshot 邏輯，並確保 renderProductList 執行時使用最新的搜尋值。
            // 這裡我們只確保 renderProductList 能拿到正確的搜尋值來篩選。
            // 由於 onSnapshot 是異步的，無法直接使用這個輸入值。
            // 最佳解是將產品列表存為全域變數，但在這裡會使代碼過於複雜。
            
            // 暫時保持現有結構，並相信 onSnapshot 重新觸發時會拿到最新的數據來渲染。
        });
        
        // --------------------------------------------------------
        // 5. 應用程式啟動點
        // --------------------------------------------------------
        window.onload = function() {
            lucide.createIcons(); // 初始化圖標
            setupFirebaseAndFetchData(); // 啟動 Firebase 流程
        };
    </script>
</body>
</html>
