<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒ¹æ ¼è¿½è¹¤å°å¹«æ‰‹ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <!-- PWA Optimization Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: none;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-bottom: 0.5rem; color: #111827; }
        .prose p { margin-bottom: 0.5rem; line-height: 1.6; color: #374151; }
        .prose strong { color: #0d9488; font-weight: 700; }
        /* Hide quantity field by default for weight items */
        #quantity-group { display: none; }
        #modal-add-price .group-item-only { transition: opacity 0.3s ease; }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div class="relative w-full h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden">
        
        <!-- Loading State Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[100] flex items-center justify-center flex-col transition-opacity duration-500">
            <div class="loader mb-4"></div>
            <p class="text-lg text-teal-600 font-medium">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</p>
        </div>

        <!-- PAGE 1: Home (Product List) -->
        <div id="page-home" class="page active">
            <header class="bg-teal-600 text-white p-4 shadow-md z-20 sticky top-0">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced"></i> åƒ¹æ ¼å°æ¯”è¿½è¹¤ (é›²ç«¯ç‰ˆ)
                </h1>
                <p class="text-sm text-teal-200 mt-1">çµ±ä¸€æ›ç®—ç‚º <span class="font-bold">æ¯å–®ä½åƒ¹æ ¼ (å…‹æˆ–ä»¶)</span> é€²è¡Œæ¯”è¼ƒ</p>
                <!-- User ID Display for Debug/Sync -->
                <p class="text-xs text-teal-300 mt-1" id="user-sync-info">åŒæ­¥ç‹€æ…‹: è¼‰å…¥ä¸­...</p>
                <!-- Search -->
                <div class="relative mt-3">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="æœå°‹å•†å“åç¨±..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-300 shadow-inner"
                        oninput="handleSearch(this.value)">
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="product-list-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Product -->
            <button onclick="openModal('modal-add-product')" class="absolute bottom-6 right-6 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-teal-700 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- PAGE 2: Detail (Price History) -->
        <div id="page-detail" class="page">
            <header class="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3 z-20 sticky top-0">
                <button onclick="goHome()" class="text-white p-2 -ml-2 btn-active">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold truncate flex-1" id="detail-title">å•†å“åç¨±</h1>
                <div class="flex gap-1">
                    <button onclick="openEditModal()" class="text-white p-2 btn-active" title="ç·¨è¼¯åç¨±">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                     <button onclick="deleteCurrentProduct()" class="text-white p-2 btn-active" title="åˆªé™¤å•†å“">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </header>

            <!-- Stats Area (Now showing Min Price per Unit) -->
            <div class="bg-white p-4 shadow-sm mb-2 z-10 sticky top-[64px] flex justify-between items-end">
                <div>
                    <p class="text-xs text-gray-500 mb-1 font-bold text-teal-600">
                        <i class="fa-solid fa-crown text-yellow-400 mr-1"></i>æ­·å²æœ€ä½å°æ¯”åƒ¹ (æ¯å–®ä½)
                    </p>
                    <div class="flex items-end gap-2">
                        <span class="text-3xl font-bold text-teal-600" id="detail-min-price">--</span>
                        <span class="text-sm text-gray-400 mb-1" id="detail-min-unit">å…ƒ / å–®ä½</span>
                    </div>
                </div>
                <button onclick="analyzePriceHistory()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-indigo-200 transition-colors btn-active">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½åˆ†æ
                </button>
            </div>

            <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24" id="price-history-container">
                <!-- Content injected via JS -->
            </main>

            <!-- FAB: Add Price -->
            <button onclick="openModal('modal-add-price')" class="absolute bottom-6 right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl btn-active z-30 hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- MODAL: Add Product -->
        <div id="modal-add-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢å•†å“</h2>
                <input type="text" id="input-product-name" placeholder="ä¾‹å¦‚ï¼šé›è›‹ã€è¡›ç”Ÿç´™..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="addProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">æ–°å¢</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Edit Product Name -->
        <div id="modal-edit-product" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ä¿®æ”¹å•†å“åç¨±</h2>
                <input type="text" id="input-edit-product-name" placeholder="è¼¸å…¥æ–°çš„åç¨±..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-product')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveEditProduct()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Add Price (Unit Price Comparison Focused) -->
        <div id="modal-add-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">è¨˜ä¸€ç­†åƒ¹æ ¼ (çµ±ä¸€å°æ¯”)</h2>
                    <p class="text-sm text-orange-600 font-medium">é‡é‡: /g, ç‰©å“: /ä»¶</p>
                </div>
                
                <!-- ç¸½åƒ¹èˆ‡å–®ä½è¼¸å…¥ -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">åŸå§‹åƒ¹æ ¼æ•¸å€¼ (ç¸½åƒ¹)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-raw-price" placeholder="ä¾‹å¦‚: 99.9 æˆ– 25000 (ç¸½åƒ¹)" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                        <select id="input-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-orange-500" onchange="toggleQuantityInput(this.value)">
                            <option value="" disabled selected>è«‹é¸å–®ä½</option>
                            <option value="per_item">å…ƒ / ä»¶ (æ¯ä»¶/æ¯åŒ…è£)</option>
                            <option value="per_g">å…ƒ / g (æ¯å…‹)</option>
                            <option value="per_100g">å…ƒ / 100g (æ¯ç™¾å…‹)</option>
                            <option value="per_kg">å…ƒ / kg (æ¯å…¬æ–¤)</option>
                            <option value="per_lb">å…ƒ / lb (æ¯ç£…)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="add-error-message"></p>
                </div>

                <!-- çµ„åˆæ•¸é‡è¼¸å…¥ (é‡å° "å…ƒ / ä»¶" é¡å‹é¡¯ç¤º) -->
                <div id="quantity-group" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-orange-500"></i> æ•¸é‡ (åŒ…è£å…§å¯¦éš›ä»¶æ•¸)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-price-quantity" placeholder="ä¾‹å¦‚: 3 (è‹¥ç‚º $100/3 ä»¶)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">åœ°é» (é¸å¡«)</label>
                    <input type="text" id="input-price-location" placeholder="ä¾‹å¦‚: å…¨è¯/Costco" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="input-price-note" placeholder="ä¾‹å¦‚ï¼šæœƒå“¡ç‰¹åƒ¹/ä¿ƒéŠ·æ´»å‹•..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-add-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="addPrice()" class="px-6 py-2 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 shadow-md btn-active transition-colors">è¨ˆç®—ä¸¦å„²å­˜</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Edit Price -->
        <div id="modal-edit-price" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ç·¨è¼¯åƒ¹æ ¼ç´€éŒ„</h2>
                
                <!-- åƒ¹æ ¼èˆ‡å–®ä½è¼¸å…¥ (ç·¨è¼¯æ¨¡å¼) -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">åŸå§‹åƒ¹æ ¼æ•¸å€¼ (ç¸½åƒ¹)</label>
                    <div class="flex">
                        <input type="number" step="any" id="input-edit-raw-price" placeholder="0" class="w-2/3 border border-gray-300 rounded-l-lg p-3 text-xl font-bold focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all">
                        <select id="input-edit-price-unit" class="w-1/3 border border-l-0 border-gray-300 rounded-r-lg p-3 bg-gray-50 text-gray-700 focus:outline-none focus:border-teal-500" onchange="toggleQuantityInputEdit(this.value)">
                            <option value="per_item">å…ƒ / ä»¶ (æ¯ä»¶/æ¯åŒ…è£)</option>
                            <option value="per_g">å…ƒ / g (æ¯å…‹)</option>
                            <option value="per_100g">å…ƒ / 100g (æ¯ç™¾å…‹)</option>
                            <option value="per_kg">å…ƒ / kg (æ¯å…¬æ–¤)</option>
                            <option value="per_lb">å…ƒ / lb (æ¯ç£…)</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-500 mt-1" id="edit-error-message"></p>
                </div>

                 <!-- çµ„åˆæ•¸é‡è¼¸å…¥ (ç·¨è¼¯æ¨¡å¼) -->
                <div id="quantity-group-edit" class="mb-4 group-item-only">
                    <label class="block text-sm text-gray-500 mb-1 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-cubes-stacked text-teal-500"></i> æ•¸é‡ (åŒ…è£å…§å¯¦éš›ä»¶æ•¸)
                    </label>
                    <input type="number" step="1" min="1" value="1" id="input-edit-price-quantity" placeholder="ä¾‹å¦‚: 3 (è‹¥ç‚º $100/3 ä»¶)" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-500 mb-1">åœ°é» (é¸å¡«)</label>
                    <input type="text" id="input-edit-price-location" placeholder="ä¾‹å¦‚: å…¨è¯" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="input-edit-price-note" placeholder="ä¾‹å¦‚ï¼šæœƒå“¡ç‰¹åƒ¹..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-teal-500 transition-all">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('modal-edit-price')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveEditPrice()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-md btn-active transition-colors">å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- MODAL: AI Analysis -->
        <div id="modal-ai-result" class="absolute inset-0 bg-black/50 hidden z-50 items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-5/6 rounded-2xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI åˆ†æå ±å‘Š
                    </h2>
                    <button onclick="closeModal('modal-ai-result')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div id="ai-result-content" class="prose text-sm">
                    <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                        <div class="loader mb-3"></div>
                        <p>Gemini æ­£åœ¨åˆ†ææ•¸æ“šä¸­...</p>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeModal('modal-ai-result')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm">é—œé–‰</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Constants
        const apiKey = ""; 
        const LB_TO_G = 453.592; // 1 ç£…ç´„ç­‰æ–¼ 453.592 å…‹

        // Firebase Services
        let db;
        let auth;
        let userId = 'loading'; // Will be set after auth
        let isAuthReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- State Management ---
        let products = [];
        let currentProductId = null;
        let currentSearchTerm = '';
        let editingPriceId = null; 

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            setLogLevel('Debug');
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è¨­ç½® Auth ç‹€æ…‹ç›£è½å™¨
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-sync-info').textContent = `å·²åŒæ­¥ (ç”¨æˆ¶ID: ${userId})`;
                        listenToProducts(); // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                        document.getElementById('loading-overlay').classList.add('opacity-0');
                        setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);

                    } else if (!isAuthReady) {
                        // è™•ç†é¦–æ¬¡ç™»å…¥æˆ–åŒ¿åç™»å…¥
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Sign-In Error:", error);
                            document.getElementById('user-sync-info').textContent = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®";
                        }
                    }
                });
            } else {
                console.error("Firebase Config is missing. Cannot proceed with cloud sync.");
                document.getElementById('user-sync-info').textContent = "ç¼ºå°‘ Firebase é…ç½®ï¼Œç„¡æ³•åŒæ­¥";
            }
        }
        
        /** å–å¾— Firestore æ”¶è—è·¯å¾‘ */
        function getProductsCollectionRef() {
            if (!db || !userId) return null;
            // ä½¿ç”¨ private path: /artifacts/{appId}/users/{userId}/products
            return collection(db, `artifacts/${appId}/users/${userId}/products`);
        }

        /** å–å¾— Firestore æ–‡ä»¶è·¯å¾‘ */
        function getProductDocRef(productId) {
            const colRef = getProductsCollectionRef();
            return colRef ? doc(colRef, String(productId)) : null;
        }

        /**
         * å¯¦æ™‚ç›£è½ç”¢å“åˆ—è¡¨ (æ›¿ä»£ loadData)
         */
        function listenToProducts() {
            const colRef = getProductsCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                products = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // å°‡ prices é™£åˆ—ååºåˆ—åŒ– (å¦‚æœéœ€è¦)
                    // æ³¨æ„ï¼šFirestore è®€å–/å¯«å…¥æ•´å€‹ products é™£åˆ—æ™‚ï¼Œé™£åˆ—ä¸­çš„ç‰©ä»¶å¯ä»¥è¢«ç›´æ¥å„²å­˜ã€‚
                    products.push({
                        id: doc.id,
                        name: data.name,
                        prices: data.prices || [] // Ensure prices is an array
                    });
                });
                renderProductList();

                // å¦‚æœåœ¨è©³ç´°é é¢ï¼Œä¸”è³‡æ–™æœ‰æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“è©³ç´°é é¢
                if (currentProductId) {
                    const productExists = products.some(p => p.id === currentProductId);
                    if (productExists) {
                        renderProductDetail();
                    } else {
                        // ç•¶å‰å•†å“è¢«åˆªé™¤æ™‚ï¼Œè·³å›ä¸»é 
                        goHome();
                    }
                }
            }, (error) => {
                console.error("Firestore listen error: ", error);
            });
        }


        // --- UI Helpers ---

        function toggleQuantityInput(unit, mode = 'add') {
            const quantityGroupEl = document.getElementById(mode === 'add' ? 'quantity-group' : 'quantity-group-edit');
            if (unit === 'per_item') {
                quantityGroupEl.style.display = 'block';
            } else {
                quantityGroupEl.style.display = 'none';
                document.getElementById(mode === 'add' ? 'input-price-quantity' : 'input-edit-price-quantity').value = 1;
            }
        }
        function toggleQuantityInputEdit(unit) {
            toggleQuantityInput(unit, 'edit');
        }

        // --- Core Price Conversion Logic (Same as before) ---
        function calculateStandardPrice(price, unit, quantity = 1) {
            if (isNaN(price) || price <= 0) return { standardPrice: 0, standardUnitLabel: 'N/A' };
            if (unit === 'per_item' && (isNaN(quantity) || quantity <= 0)) {
                quantity = 1; 
            }

            let standardPrice = 0;
            let standardUnitLabel = 'N/A';

            switch (unit) {
                case 'per_item':
                    standardPrice = price / quantity;
                    standardUnitLabel = 'ä»¶';
                    break;
                case 'per_g':
                    standardPrice = price;
                    standardUnitLabel = 'g';
                    break;
                case 'per_100g':
                    standardPrice = price / 100;
                    standardUnitLabel = 'g';
                    break;
                case 'per_kg':
                    standardPrice = price / 1000;
                    standardUnitLabel = 'g';
                    break;
                case 'per_lb':
                    standardPrice = price / LB_TO_G;
                    standardUnitLabel = 'g';
                    break;
                default:
                    return { standardPrice: 0, standardUnitLabel: 'N/A' };
            }
            
            const precision = standardUnitLabel === 'g' ? 4 : 2;
            return { 
                standardPrice: parseFloat(standardPrice.toFixed(precision)), 
                standardUnitLabel: standardUnitLabel 
            };
        }
        
        // --- Navigation / Modal Logic ---

        function goDetail(id) {
            currentProductId = id;
            renderProductDetail();
            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
        }

        function goHome() {
            currentProductId = null;
            renderProductList();
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('page-home').classList.add('active');
        }

        function openEditModal() {
            const product = products.find(p => p.id === currentProductId);
            if (product) {
                document.getElementById('input-edit-product-name').value = product.name;
                openModal('modal-edit-product');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
            
            if (modalId === 'modal-add-price') {
                document.getElementById('input-raw-price').value = '';
                document.getElementById('input-price-unit').value = ''; 
                document.getElementById('input-price-quantity').value = 1; 
                document.getElementById('input-price-note').value = '';
                document.getElementById('input-price-location').value = '';
                document.getElementById('add-error-message').textContent = '';
                document.getElementById('quantity-group').style.display = 'none'; 
                setTimeout(() => document.getElementById('input-raw-price').focus(), 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function handleSearch(value) {
            currentSearchTerm = value.trim().toLowerCase();
            renderProductList();
        }

        // --- Firestore CRUD Operations ---

        async function addProduct() {
            if (!isAuthReady) return;

            const name = document.getElementById('input-product-name').value.trim();
            if (!name) return;

            try {
                // ä½¿ç”¨ setDoc ä¸¦æŒ‡å®šä¸€å€‹æ–°çš„ ID (Date.now())ï¼Œä»¥ä¾¿æ–¼å¾ŒçºŒæŸ¥æ‰¾å’Œåˆªé™¤
                const newProductId = Date.now();
                const newProductRef = getProductDocRef(newProductId);

                await setDoc(newProductRef, { 
                    name: name, 
                    prices: [] 
                });
                
                closeModal('modal-add-product');
                // listenToProducts æœƒè‡ªå‹•æ›´æ–° UI
            } catch (e) {
                console.error("Error adding document: ", e);
                // æ‡‰é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
            }
        }
        
        async function deleteCurrentProduct() {
            if (!isAuthReady) return;

            // ç‚ºäº†ç°¡æ½”ï¼Œä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ç¢ºèªæ¡† (å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰ä½¿ç”¨å®¢è£½åŒ– Modal)
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ "${document.getElementById('detail-title').textContent}" åŠå…¶æ‰€æœ‰åƒ¹æ ¼ç´€éŒ„å—ï¼Ÿ`)) return;

            try {
                const productRef = getProductDocRef(currentProductId);
                if (productRef) {
                    await deleteDoc(productRef);
                    goHome();
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        async function saveEditProduct() {
            if (!isAuthReady) return;

            const newName = document.getElementById('input-edit-product-name').value.trim();
            if (!newName) return;

            try {
                const productRef = getProductDocRef(currentProductId);
                if (productRef) {
                    await setDoc(productRef, { name: newName }, { merge: true });
                    closeModal('modal-edit-product');
                    // listenToProducts æœƒè‡ªå‹•æ›´æ–° UI
                }
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }
        
        async function addPrice() {
            if (!isAuthReady) return;

            const rawPrice = parseFloat(document.getElementById('input-raw-price').value);
            const rawUnit = document.getElementById('input-price-unit').value;
            let rawQuantity = parseFloat(document.getElementById('input-price-quantity').value); 
            const note = document.getElementById('input-price-note').value.trim();
            const location = document.getElementById('input-price-location').value.trim();
            const errorMsgEl = document.getElementById('add-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(rawPrice) || rawPrice <= 0) { 
                errorMsgEl.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼æ•¸å€¼ (ç¸½åƒ¹)"; return; 
            }
            if (!rawUnit) {
                errorMsgEl.textContent = "è«‹é¸æ“‡åŸå§‹åƒ¹æ ¼å–®ä½"; return; 
            }
            if (rawUnit === 'per_item') {
                if (isNaN(rawQuantity) || rawQuantity <= 0) {
                     errorMsgEl.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ (ä»¶æ•¸)"; return; 
                }
            } else {
                rawQuantity = 1; 
            }
            
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(rawPrice, rawUnit, rawQuantity);
            const product = products.find(p => p.id === currentProductId);

            if (product) {
                const newPriceEntry = { 
                    id: crypto.randomUUID(), // ä½¿ç”¨ UUID ä½œç‚ºåƒ¹æ ¼ç´€éŒ„çš„å”¯ä¸€ ID
                    rawPrice, 
                    rawUnit,
                    rawQuantity,            
                    standardPrice,          
                    standardUnitLabel,      
                    date: new Date().toISOString(), // Use ISO string for reliable sorting/storage
                    note, 
                    location, 
                };
                
                // å°‡æ–°çš„åƒ¹æ ¼ç´€éŒ„åŠ å…¥åˆ°ç¾æœ‰çš„ prices é™£åˆ—ä¸­
                const newPrices = [newPriceEntry, ...(product.prices || [])];

                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    closeModal('modal-add-price');
                    // listenToProducts æœƒè‡ªå‹•æ›´æ–° UI
                } catch (e) {
                    console.error("Error adding price: ", e);
                }
            }
        }

        async function deletePrice(priceId) {
            if (!isAuthReady) return;

            // ç‚ºäº†ç°¡æ½”ï¼Œä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ç¢ºèªæ¡†
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†åƒ¹æ ¼ç´€éŒ„å—ï¼Ÿ")) return;
            
            const product = products.find(p => p.id === currentProductId);
            if (product) {
                const newPrices = product.prices.filter(p => p.id !== priceId);

                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    // listenToProducts æœƒè‡ªå‹•æ›´æ–° UI
                } catch (e) {
                    console.error("Error deleting price: ", e);
                }
            }
        }

        function openEditPriceModal(priceId) {
            const product = products.find(p => p.id === currentProductId);
            const entry = product ? product.prices.find(p => p.id === priceId) : null;

            if (!entry) return;
            editingPriceId = priceId;

            document.getElementById('input-edit-raw-price').value = entry.rawPrice;
            document.getElementById('input-edit-price-unit').value = entry.rawUnit;
            document.getElementById('input-edit-price-note').value = entry.note;
            document.getElementById('input-edit-price-location').value = entry.location;
            document.getElementById('edit-error-message').textContent = '';
            
            document.getElementById('input-edit-price-quantity').value = entry.rawQuantity ?? 1;
            
            toggleQuantityInputEdit(entry.rawUnit);
            openModal('modal-edit-price');
        }

        async function saveEditPrice() {
            if (!isAuthReady || !editingPriceId) return;

            const newRawPrice = parseFloat(document.getElementById('input-edit-raw-price').value);
            const newRawUnit = document.getElementById('input-edit-price-unit').value;
            let newRawQuantity = parseFloat(document.getElementById('input-edit-price-quantity').value); 
            const newNote = document.getElementById('input-edit-price-note').value.trim();
            const newLocation = document.getElementById('input-edit-price-location').value.trim();
            const errorMsgEl = document.getElementById('edit-error-message');

            errorMsgEl.textContent = '';
            if (isNaN(newRawPrice) || newRawPrice <= 0) { 
                errorMsgEl.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼æ•¸å€¼ (ç¸½åƒ¹)"; return; 
            }

            if (newRawUnit === 'per_item') {
                if (isNaN(newRawQuantity) || newRawQuantity <= 0) {
                     errorMsgEl.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ (ä»¶æ•¸)"; return; 
                }
            } else {
                newRawQuantity = 1; 
            }
            
            const { standardPrice, standardUnitLabel } = calculateStandardPrice(newRawPrice, newRawUnit, newRawQuantity);


            const product = products.find(p => p.id === currentProductId);
            if (product) {
                // æ‰¾å‡ºè¦æ›´æ–°çš„åƒ¹æ ¼ç´€éŒ„ï¼Œä¸¦å»ºç«‹æ–°çš„ prices é™£åˆ—
                const newPrices = product.prices.map(p => {
                    if (p.id === editingPriceId) {
                        return {
                            ...p,
                            rawPrice: newRawPrice,
                            rawUnit: newRawUnit,
                            rawQuantity: newRawQuantity,
                            note: newNote,
                            location: newLocation,
                            standardPrice: standardPrice,
                            standardUnitLabel: standardUnitLabel,
                        };
                    }
                    return p;
                });
                
                try {
                    const productRef = getProductDocRef(currentProductId);
                    await setDoc(productRef, { prices: newPrices }, { merge: true });
                    
                    closeModal('modal-edit-price');
                    editingPriceId = null;
                    // listenToProducts æœƒè‡ªå‹•æ›´æ–° UI
                } catch (e) {
                    console.error("Error saving price edit: ", e);
                }
            }
        }


        // --- Render UI (Same as before) ---
        function renderProductList() {
            const container = document.getElementById('product-list-container');
            // å°‡ç”¢å“åˆ—è¡¨æŒ‰ ID æ’åº (æœ€æ–°æ–°å¢çš„åœ¨å‰)
            const sortedProducts = [...products].sort((a, b) => parseInt(b.id) - parseInt(a.id));
            const filtered = sortedProducts.filter(p => p.name.toLowerCase().includes(currentSearchTerm));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><p>æ‰¾ä¸åˆ°å•†å“</p><p class="text-sm">é»æ“Šå³ä¸‹è§’æ–°å¢</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(product => {
                const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;
                
                let priceDisplay = `<span class="text-gray-400 text-sm">ç„¡åƒ¹æ ¼</span>`;

                if (minEntry) {
                    const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                    const unitText = minEntry.standardUnitLabel === 'g' ? 'å…‹' : 'ä»¶';
                    
                    priceDisplay = `
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-gray-400">æœ€ä½/ ${unitText}</span>
                            <span class="text-teal-600 font-bold text-lg">$${priceFormatted}</span>
                        </div>`; 
                }

                return `
                <div onclick="goDetail('${product.id}')" class="bg-white p-4 rounded-xl shadow-sm mb-3 flex justify-between items-center btn-active cursor-pointer border-l-4 border-teal-500">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${product.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">ç´€éŒ„: ${product.prices.length} ç­†</p>
                    </div>
                    <div class="flex items-center">${priceDisplay}<i class="fa-solid fa-chevron-right text-gray-300 ml-3"></i></div>
                </div>`;
            }).join('');
        }

        function getUnitLabel(unit) {
             switch (unit) {
                case 'per_item': return 'å…ƒ / ä»¶ (æ¯ä»¶/åŒ…è£)';
                case 'per_g': return 'å…ƒ / g (æ¯å…‹)';
                case 'per_100g': return 'å…ƒ / 100g (æ¯ç™¾å…‹)';
                case 'per_kg': return 'å…ƒ / kg (æ¯å…¬æ–¤)';
                case 'per_lb': return 'å…ƒ / lb (æ¯ç£…)';
                default: return 'æœªçŸ¥å–®ä½';
            }
        }

        function renderProductDetail() {
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;

            document.getElementById('detail-title').textContent = product.name;
            const minPriceEl = document.getElementById('detail-min-price');
            const minUnitEl = document.getElementById('detail-min-unit');
            
            const minEntry = product.prices.length > 0 ? product.prices.reduce((min, p) => p.standardPrice < min.standardPrice ? p : min, product.prices[0]) : null;

            if (minEntry) {
                const priceFormatted = minEntry.standardUnitLabel === 'g' ? minEntry.standardPrice.toFixed(4) : minEntry.standardPrice.toFixed(2);
                minPriceEl.textContent = priceFormatted;
                minUnitEl.textContent = `å…ƒ / ${minEntry.standardUnitLabel}`;
            } else {
                minPriceEl.textContent = '--';
                minUnitEl.textContent = 'å…ƒ / å–®ä½';
            }


            const container = document.getElementById('price-history-container');
            // å°‡åƒ¹æ ¼ç´€éŒ„æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
            product.prices.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (product.prices.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><p>å°šç„¡ç´€éŒ„</p></div>`;
                return;
            }

            container.innerHTML = product.prices.map((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
                
                let diffHtml = '';
                let diffPrecision = entry.standardUnitLabel === 'g' ? 4 : 2; 
                
                if (index < product.prices.length - 1) {
                    const prevEntry = product.prices[index + 1];
                    if (entry.standardUnitLabel === prevEntry.standardUnitLabel) {
                        const diff = entry.standardPrice - prevEntry.standardPrice;
                        if (diff > 0) diffHtml = `<span class="text-red-500 text-xs ml-2">â–² ${diff.toFixed(diffPrecision)}</span>`;
                        else if (diff < 0) diffHtml = `<span class="text-green-500 text-xs ml-2">â–¼ ${Math.abs(diff).toFixed(diffPrecision)}</span>`;
                    }
                }

                const unitLabel = getUnitLabel(entry.rawUnit);
                
                const priceFormatted = entry.standardUnitLabel === 'g' ? entry.standardPrice.toFixed(4) : entry.standardPrice.toFixed(2);
                const standardUnitText = entry.standardUnitLabel === 'g' ? `g (æ¯å…‹å°æ¯”åƒ¹)` : `ä»¶ (æ¯ä»¶å°æ¯”åƒ¹)`;

                const quantityText = entry.rawUnit === 'per_item' && entry.rawQuantity > 1 
                                     ? ` (å…± ${entry.rawQuantity} ä»¶)` 
                                     : '';
                
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-2 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <!-- é¡¯ç¤ºçµ±ä¸€çš„æ¨™æº–åŒ–åƒ¹æ ¼ (æœ€é‡è¦) -->
                            <span class="text-xl font-bold text-teal-600">$${priceFormatted}</span>
                            <span class="text-sm font-medium text-teal-500 ml-1">/ ${standardUnitText}</span>
                            ${diffHtml}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">åŸå§‹è¼¸å…¥: ç¸½åƒ¹ $${entry.rawPrice} (${unitLabel})${quantityText}</p>
                        
                        ${entry.location ? `<p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-location-dot mr-1 text-teal-500"></i>${entry.location}</p>` : ''}
                        ${entry.note ? `<p class="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">${entry.note}</p>` : ''}
                    </div>
                    <div class="text-right whitespace-nowrap ml-2 flex flex-col items-end">
                        <p class="text-xs text-gray-400">${dateStr}</p>
                        <div class="mt-2 flex gap-2">
                             <button onclick="openEditPriceModal('${entry.id}')" class="text-teal-500 hover:text-teal-700 text-sm p-1 btn-active" title="ç·¨è¼¯ç´€éŒ„"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button onclick="deletePrice('${entry.id}')" class="text-red-400 hover:text-red-600 text-sm p-1 btn-active" title="åˆªé™¤ç´€éŒ„"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- AI Analysis ---
        async function analyzePriceHistory() {
            // This function is mocked as API calls are not supported in this environment without an actual key.
            // The structure is kept for demonstration.
            const product = products.find(p => p.id === currentProductId);
            if (!product || product.prices.length === 0) {
                // æ‡‰ä½¿ç”¨å®¢è£½åŒ– Modal è€Œé console.warn/alert
                console.warn("è«‹å…ˆæ–°å¢ä¸€äº›åƒ¹æ ¼ç´€éŒ„ï¼ŒAI æ‰èƒ½é€²è¡Œåˆ†æå–”ï¼"); 
                return;
            }

            openModal('modal-ai-result');
            const container = document.getElementById('ai-result-content');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                    <div class="loader mb-3"></div>
                    <p>Gemini æ­£åœ¨åˆ†æ ${product.name} çš„åƒ¹æ ¼èµ°å‹¢...</p>
                </div>`;

            await new Promise(r => setTimeout(r, 2000)); // Simulate delay
            
            const historyData = product.prices.slice(0, 5).map(p => ({
                date: new Date(p.date).toLocaleDateString(),
                price: p.standardPrice.toFixed(p.standardUnitLabel === 'g' ? 4 : 2), 
                unit: p.standardUnitLabel,
                location: p.location,
                rawQuantity: p.rawQuantity,
            }));

            // Mocked Analysis Result
            const unitType = product.prices[0].standardUnitLabel === 'g' ? 'æ¯å…‹' : 'æ¯ä»¶';
            const lowestPrice = Math.min(...product.prices.map(p => p.standardPrice)).toFixed(unitType === 'æ¯å…‹' ? 4 : 2);
            const highestPrice = Math.max(...product.prices.map(p => p.standardPrice)).toFixed(unitType === 'æ¯å…‹' ? 4 : 2);

            const mockAnalysis = `
### ğŸ¤– ${product.name} åƒ¹æ ¼èµ°å‹¢åˆ†æ

é€™æ˜¯æ ¹æ“šæ‚¨æœ€æ–°çš„ ${product.prices.length} ç­†ç´€éŒ„å¾—å‡ºçš„åˆ†æï¼š

**1. åƒ¹æ ¼è©•ä¼°**

* **æ­·å²æœ€ä½å°æ¯”åƒ¹ï¼š** \`${lowestPrice} å…ƒ / ${unitType}\`
* **æ­·å²æœ€é«˜å°æ¯”åƒ¹ï¼š** \`${highestPrice} å…ƒ / ${unitType}\`

ç›®å‰çš„åƒ¹æ ¼æ³¢å‹•å€é–“æ˜é¡¯ï¼Œæ‚¨æœ€æ–°çš„åƒ¹æ ¼æ˜¯... (ç•¥)

**2. èµ°å‹¢åˆ†æ**

æ ¹æ“šæœ€è¿‘äº”ç­†ç´€éŒ„ï¼š
\`\`\`json
${JSON.stringify(historyData, null, 2)}
\`\`\`

ç¸½é«”è€Œè¨€ï¼Œåƒ¹æ ¼è¶¨å‹¢ (ç•¥)...

**3. è³¼è²·å»ºè­°**

å»ºè­°æ‚¨åœ¨ **ä¿ƒéŠ·æ´»å‹• (å¦‚çµ„åˆè£)** æ™‚è³¼å…¥ï¼Œå› ç‚ºé€™é€šå¸¸èƒ½å°‡ **æ¯å–®ä½åƒ¹æ ¼** æ‹‰ä½è‡³æ­·å²æœ€ä½é»é™„è¿‘ã€‚ä¾‹å¦‚ï¼Œç•¶æ‚¨çœ‹åˆ° **3ä»¶/100å…ƒ** çš„ä¿ƒéŠ·æ™‚ï¼Œå…¶å–®ä»¶åƒ¹æ ¼ \`${(100/3).toFixed(2)} å…ƒ/ä»¶\` é ä½æ–¼å–®ä»¶åŸåƒ¹ã€‚

---
*æç¤º: é€™æ˜¯æ¨¡æ“¬åˆ†æçµæœï¼Œå› ç‚º AI æœå‹™åœ¨ç•¶å‰ç’°å¢ƒä¸­ä¸å¯ç”¨ã€‚*
`;
            
            container.innerHTML = marked.parse(mockAnalysis);
        }

        // --- FIX: Expose functions to global scope for HTML inline handlers ---
        window.goDetail = goDetail;
        window.goHome = goHome;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.handleSearch = handleSearch;
        window.openEditModal = openEditModal;
        window.deleteCurrentProduct = deleteCurrentProduct;
        window.analyzePriceHistory = analyzePriceHistory;
        window.addProduct = addProduct;
        window.saveEditProduct = saveEditProduct;
        window.addPrice = addPrice;
        window.deletePrice = deletePrice;
        window.openEditPriceModal = openEditPriceModal;
        window.saveEditPrice = saveEditPrice;
        window.toggleQuantityInput = toggleQuantityInput;
        window.toggleQuantityInputEdit = toggleQuantityInputEdit;
        // --- END FIX ---

    </script>
</body>
</html>
